---
phase: 01-foundation
plan: 01
type: execute
depends_on: []
files_modified: [db/migrate/*_create_plugin_configurations.rb, db/migrate/*_create_sync_histories.rb, db/migrate/*_create_money_transactions.rb, app/models/plugin_configuration.rb, app/models/sync_history.rb, app/models/money_transaction.rb]
---

<objective>
Create database schema for the integrations platform foundation.

Purpose: Establish the data layer that all plugin functionality depends on â€” configuration storage, sync tracking, and transaction records.
Output: Three new tables with corresponding models, migrations run successfully, schema updated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@db/schema.rb

**Established patterns:**
- Rails 8.1 with SQLite3
- Standard ActiveRecord migrations
- Models in `app/models/`
- Enum-based status fields with integer backing
- Decimal precision: 12,2 for amounts, 10,2 for rates

**Constraining decisions:**
- Single-user app (no user_id foreign keys needed on most tables)
- API keys over OAuth (credentials stored as encrypted JSON)
- Full data access with audit trail (source attribution required)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plugin_configurations table</name>
  <files>db/migrate/*_create_plugin_configurations.rb, app/models/plugin_configuration.rb</files>
  <action>
Create migration for plugin_configurations table:
- plugin_name:string (not null, indexed, unique) - identifies the plugin
- enabled:boolean (default: false, not null) - whether plugin is active
- credentials:text - encrypted JSON blob for API keys, tokens, etc.
- settings:text - JSON blob for non-sensitive plugin settings
- timestamps

Create PluginConfiguration model:
- validates :plugin_name, presence: true, uniqueness: true
- encrypts :credentials (Rails 7+ attribute encryption)
- Add methods: enabled?, credentials_hash (parses JSON), settings_hash (parses JSON)

Use `rails generate migration CreatePluginConfigurations` to get proper timestamp.
Do NOT add user_id - this is a single-user app.
  </action>
  <verify>bin/rails db:migrate runs without error, PluginConfiguration.create!(plugin_name: "test", enabled: true) succeeds in rails console</verify>
  <done>plugin_configurations table exists with all columns, model validates and encrypts correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create sync_histories table</name>
  <files>db/migrate/*_create_sync_histories.rb, app/models/sync_history.rb</files>
  <action>
Create migration for sync_histories table:
- plugin_name:string (not null, indexed) - which plugin ran
- status:integer (not null, default: 0, indexed) - enum: pending, running, completed, failed
- started_at:datetime - when sync began
- completed_at:datetime - when sync finished
- records_processed:integer (default: 0) - count of records handled
- records_created:integer (default: 0) - new records created
- records_updated:integer (default: 0) - existing records modified
- error_message:text - failure details if status is failed
- error_backtrace:text - stack trace for debugging
- metadata:text - JSON blob for plugin-specific sync details
- timestamps

Create SyncHistory model:
- enum :status, { pending: 0, running: 1, completed: 2, failed: 3 }
- validates :plugin_name, presence: true
- scope :recent, -> { order(created_at: :desc).limit(10) }
- scope :for_plugin, ->(name) { where(plugin_name: name) }
- Add method: duration (returns completed_at - started_at if both present)

Use `rails generate migration CreateSyncHistories`.
  </action>
  <verify>bin/rails db:migrate runs without error, SyncHistory.create!(plugin_name: "test", status: :completed, started_at: 1.hour.ago, completed_at: Time.current) succeeds</verify>
  <done>sync_histories table exists with all columns, model has enum and scopes working</done>
</task>

<task type="auto">
  <name>Task 3: Create money_transactions table</name>
  <files>db/migrate/*_create_money_transactions.rb, app/models/money_transaction.rb</files>
  <action>
Create migration for money_transactions table:
- external_id:string (indexed) - ID from external source (bank transaction ID)
- source:string (not null, indexed) - where this came from (plugin name or "manual")
- transaction_type:integer (not null, default: 0) - enum: income, expense
- amount:decimal (precision: 12, scale: 2, not null) - transaction amount (always positive)
- currency:string (not null, default: "EUR") - ISO currency code
- description:text - transaction description/memo
- transacted_on:date (not null, indexed) - when transaction occurred
- counterparty:string - who paid/received (bank account holder name)
- reference:string - payment reference (variable symbol, invoice number)
- invoice_id:integer (indexed, nullable) - optional link to matched invoice
- raw_data:text - JSON blob of original data from source for debugging
- timestamps

Create MoneyTransaction model:
- enum :transaction_type, { income: 0, expense: 1 }
- validates :source, :amount, :currency, :transacted_on, presence: true
- validates :amount, numericality: { greater_than: 0 }
- validates :external_id, uniqueness: { scope: :source }, allow_nil: true
- belongs_to :invoice, optional: true
- scope :income, -> { where(transaction_type: :income) }
- scope :expenses, -> { where(transaction_type: :expense) }
- scope :unmatched, -> { where(invoice_id: nil) }
- scope :for_period, ->(start_date, end_date) { where(transacted_on: start_date..end_date) }

Use `rails generate migration CreateMoneyTransactions`.
Add foreign key to invoices table.
  </action>
  <verify>bin/rails db:migrate runs without error, MoneyTransaction.create!(source: "manual", transaction_type: :income, amount: 100.00, currency: "EUR", transacted_on: Date.current) succeeds</verify>
  <done>money_transactions table exists with all columns, model validates correctly, foreign key to invoices works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bin/rails db:migrate` runs without errors
- [ ] `bin/rails db:migrate:status` shows all three migrations as "up"
- [ ] `bin/rails console` - can create records in all three tables
- [ ] db/schema.rb updated with all three tables
- [ ] No pending migrations
</verification>

<success_criteria>
- All three migrations created and run successfully
- All three models created with validations and methods
- PluginConfiguration encrypts credentials field
- SyncHistory has working enum and scopes
- MoneyTransaction has foreign key to invoices
- Schema file reflects new tables
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
