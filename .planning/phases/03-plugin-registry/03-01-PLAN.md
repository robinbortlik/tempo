---
phase: 03-plugin-registry
plan: 01
type: execute
depends_on: []
files_modified: [app/plugins/plugin_registry.rb, spec/plugins/plugin_registry_spec.rb]
---

<objective>
Create a plugin registry service for discovering and listing available plugins from app/plugins/.

Purpose: Enable the application to dynamically discover all plugins at runtime without hardcoding plugin lists, supporting the extensible plugin architecture.
Output: PluginRegistry class with methods to list all plugins, find specific plugins by name, and retrieve plugin metadata.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plugin-interface/02-01-SUMMARY.md

**Key files from Phase 2:**
@app/plugins/base_plugin.rb
@app/plugins/example_plugin.rb

**Tech stack available:** Rails 8.1, Ruby 3.3
**Established patterns:**
- Plugin interface contract: name, version, description (class methods), sync (instance method)
- NotImplementedError for unimplemented contract methods
- ExamplePlugin as reference implementation

**Constraining decisions:**
- Phase 2: Used NotImplementedError with descriptive messages for contract enforcement
- Phase 2: Memoized configuration lookup for performance (apply same pattern for registry caching)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PluginRegistry class with discovery methods</name>
  <files>app/plugins/plugin_registry.rb</files>
  <action>
Create PluginRegistry as a singleton-style class with class methods:

1. `.all` - Returns array of all plugin classes that inherit from BasePlugin
   - Load all .rb files from app/plugins/ directory (except base_plugin.rb and plugin_registry.rb)
   - Filter to classes that are subclasses of BasePlugin
   - Cache result in class instance variable (memoization pattern from Phase 2)
   - Provide `.reload!` method to clear cache during development/testing

2. `.find(name)` - Returns single plugin class by name, or nil if not found
   - Uses `.all` internally, finds by plugin's .name class method
   - Case-insensitive comparison for robustness

3. `.find!(name)` - Same as find but raises error if not found
   - Raises PluginNotFoundError (define as PluginRegistry::NotFoundError)

4. `.registered_names` - Returns array of all plugin names (convenience method)
   - Maps .all to their .name values

5. `.metadata` - Returns array of hashes with plugin info
   - Each hash: { name:, version:, description:, class: }
   - Useful for UI display of available plugins

Implementation notes:
- Use Dir.glob for file discovery: Rails.root.join("app/plugins/*.rb")
- Skip loading base_plugin.rb and plugin_registry.rb
- Use require_dependency or load for each file to ensure classes are defined
- Filter ObjectSpace.each_object(Class).select { |c| c < BasePlugin } after loading
- Handle load errors gracefully with Rails.logger.error

Do NOT use complex autoloading or Zeitwerk configuration. Keep it simple and explicit.
  </action>
  <verify>
```bash
# Verify file exists with all methods
grep -E "def self\.(all|find|find!|registered_names|metadata|reload!)" app/plugins/plugin_registry.rb
```
  </verify>
  <done>PluginRegistry class exists with all 6 class methods (all, find, find!, registered_names, metadata, reload!)</done>
</task>

<task type="auto">
  <name>Task 2: Write comprehensive specs for PluginRegistry</name>
  <files>spec/plugins/plugin_registry_spec.rb</files>
  <action>
Create RSpec tests covering:

1. `.all` method:
   - Returns array of plugin classes
   - Includes ExamplePlugin in results
   - Does NOT include BasePlugin itself
   - Does NOT include PluginRegistry
   - Caches results (same object returned on subsequent calls)

2. `.reload!` method:
   - Clears the cache
   - Returns fresh results after reload

3. `.find(name)` method:
   - Returns plugin class when found (ExamplePlugin via "example")
   - Returns nil when not found
   - Works case-insensitively ("Example" finds "example")

4. `.find!(name)` method:
   - Returns plugin class when found
   - Raises PluginRegistry::NotFoundError when not found
   - Error message includes the requested name

5. `.registered_names` method:
   - Returns array of strings
   - Includes "example" (from ExamplePlugin)

6. `.metadata` method:
   - Returns array of hashes
   - Each hash has :name, :version, :description, :class keys
   - ExamplePlugin metadata is accurate

Test setup:
- Use before(:each) { PluginRegistry.reload! } to ensure clean state
- ExamplePlugin should be auto-discovered as it exists in app/plugins/

Do NOT mock file system or plugin loading - test real discovery.
  </action>
  <verify>
```bash
bundle exec rspec spec/plugins/plugin_registry_spec.rb --format documentation
```
  </verify>
  <done>All specs pass, comprehensive coverage of registry functionality</done>
</task>

<task type="auto">
  <name>Task 3: Verify integration with existing plugins</name>
  <files>app/plugins/plugin_registry.rb</files>
  <action>
Run Rails console verification to ensure registry works with actual codebase:

```ruby
# In rails console
PluginRegistry.reload!
PluginRegistry.all
PluginRegistry.registered_names
PluginRegistry.find("example")
PluginRegistry.metadata
```

If any issues found during verification, fix them in the PluginRegistry implementation.

Also ensure the registry is loaded by Rails by adding to config/application.rb or an initializer if needed.
Check that app/plugins is in the autoload paths (it may need explicit configuration).
  </action>
  <verify>
```bash
# Run in Rails console and verify output
bundle exec rails runner "puts PluginRegistry.registered_names.inspect"
```
Output should include "example".
  </verify>
  <done>PluginRegistry correctly discovers ExamplePlugin in Rails environment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bundle exec rspec spec/plugins/plugin_registry_spec.rb` passes all tests
- [ ] `bundle exec rails runner "puts PluginRegistry.all.count"` returns at least 1
- [ ] `bundle exec rails runner "puts PluginRegistry.find('example').name"` returns "example"
- [ ] No new warnings or errors in test output
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PluginRegistry discovers ExamplePlugin correctly
- Registry methods work as specified (all, find, find!, registered_names, metadata, reload!)
- Specs provide coverage for all public methods
</success_criteria>

<output>
After completion, create `.planning/phases/03-plugin-registry/03-01-SUMMARY.md`
</output>
