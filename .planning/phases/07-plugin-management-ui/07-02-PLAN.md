---
phase: 07-plugin-management-ui
plan: 02
title: Plugin configuration forms
subsystem: frontend
tags: [react, typescript, inertia, forms, zod]

# Dependency graph
requires:
  - phase: 07-plugin-management-ui
    plan: 01
    provides: [PluginsController, PluginSerializer, routes]
  - phase: 04-plugin-configuration
    provides: [PluginConfigurationService, update_credentials, update_settings]
provides:
  - Plugins/Configure.tsx page component
  - Credential input forms with secure handling
  - Settings forms per plugin
  - Configure/update controller actions
affects: [07-03]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "react-hook-form with Zod validation"
    - "Secure credential input (password type)"
    - "Dynamic form fields based on plugin schema"
---

# Plan: Plugin Configuration Forms

**Goal:** Create plugin configuration forms for entering credentials and settings per plugin

## Context

### From Plan 07-01
- `PluginsController` exists with index, enable, disable, sync actions
- `PluginSerializer` serializes plugin data
- Routes exist for `/plugins`
- Configure button navigates to `/plugins/:id/configure`

### From Phase 4 (Plugin Configuration)
- `PluginConfigurationService#update_credentials(hash)` stores encrypted credentials
- `PluginConfigurationService#update_settings(hash)` stores settings
- `PluginConfiguration#credentials_hash` returns decrypted credentials as hash
- `PluginConfiguration#settings_hash` returns settings as hash

### Existing Patterns
- Forms use react-hook-form with Zod schemas
- Password inputs for sensitive fields
- Controllers redirect with flash messages after form submission

### This Plan Adds

1. `configure` action to PluginsController (show form)
2. `update_credentials` and `update_settings` actions
3. `Plugins/Configure.tsx` page component with forms
4. Credential schema definition per plugin (extensible pattern)

## Tasks

### Task 1: Add configure action to PluginsController

Extend the controller with configure, update_credentials, and update_settings actions.

**File:** `app/controllers/plugins_controller.rb` (modify existing)

Add after the existing actions:

```ruby
def configure
  service = PluginConfigurationService.new(plugin_name: @plugin_name)

  render inertia: "Plugins/Configure", props: {
    plugin: PluginSerializer.new(service.summary).serializable_hash,
    credentials: mask_credentials(service.configuration.credentials_hash),
    settings: service.configuration.settings_hash,
    credential_fields: credential_fields_for(@plugin_name),
    setting_fields: setting_fields_for(@plugin_name)
  }
rescue PluginRegistry::NotFoundError => e
  redirect_to plugins_path, alert: e.message
end

def update_credentials
  service = PluginConfigurationService.new(plugin_name: @plugin_name)
  result = service.replace_credentials(credentials_params.to_h)

  if result[:success]
    redirect_to configure_plugin_path(@plugin_name), notice: t("flash.plugins.credentials_saved")
  else
    redirect_to configure_plugin_path(@plugin_name), alert: result[:errors].to_sentence
  end
rescue PluginRegistry::NotFoundError => e
  redirect_to plugins_path, alert: e.message
end

def update_settings
  service = PluginConfigurationService.new(plugin_name: @plugin_name)
  result = service.replace_settings(settings_params.to_h)

  if result[:success]
    redirect_to configure_plugin_path(@plugin_name), notice: t("flash.plugins.settings_saved")
  else
    redirect_to configure_plugin_path(@plugin_name), alert: result[:errors].to_sentence
  end
rescue PluginRegistry::NotFoundError => e
  redirect_to plugins_path, alert: e.message
end

def clear_credentials
  service = PluginConfigurationService.new(plugin_name: @plugin_name)
  result = service.clear_credentials!

  if result[:success]
    redirect_to configure_plugin_path(@plugin_name), notice: t("flash.plugins.credentials_cleared")
  else
    redirect_to configure_plugin_path(@plugin_name), alert: result[:errors].to_sentence
  end
rescue PluginRegistry::NotFoundError => e
  redirect_to plugins_path, alert: e.message
end
```

Add private helper methods:

```ruby
private

# Mask credential values for display (show only last 4 chars)
def mask_credentials(credentials)
  credentials.transform_values do |value|
    next value if value.nil? || value.to_s.length <= 4
    "#{"*" * (value.to_s.length - 4)}#{value.to_s[-4..]}"
  end
end

# Define credential fields per plugin (extensible)
# Override in subclass or use plugin metadata in future
def credential_fields_for(plugin_name)
  # Default credential fields - plugins can define their own via class method
  plugin_class = PluginRegistry.find(plugin_name)

  if plugin_class.respond_to?(:credential_fields)
    plugin_class.credential_fields
  else
    # Default fields for most API integrations
    [
      { name: "api_key", label: "API Key", type: "password", required: true },
      { name: "api_secret", label: "API Secret", type: "password", required: false }
    ]
  end
end

# Define setting fields per plugin (extensible)
def setting_fields_for(plugin_name)
  plugin_class = PluginRegistry.find(plugin_name)

  if plugin_class.respond_to?(:setting_fields)
    plugin_class.setting_fields
  else
    # Default settings
    [
      { name: "sync_from_date", label: "Sync from date", type: "date", required: false },
      { name: "import_limit", label: "Import limit", type: "number", required: false }
    ]
  end
end

def credentials_params
  # Permit all credential fields dynamically
  permitted_keys = credential_fields_for(@plugin_name).map { |f| f[:name].to_sym }
  params.require(:credentials).permit(permitted_keys)
end

def settings_params
  # Permit all setting fields dynamically
  permitted_keys = setting_fields_for(@plugin_name).map { |f| f[:name].to_sym }
  params.require(:settings).permit(permitted_keys)
end
```

**Verification:**
- No syntax errors: `ruby -c app/controllers/plugins_controller.rb`

### Task 2: Update routes for configuration actions

**File:** `config/routes.rb` (modify existing)

Update the plugins resource to include configuration routes:

```ruby
resources :plugins, only: [:index] do
  member do
    patch :enable
    patch :disable
    post :sync
    get :configure
    patch :update_credentials
    patch :update_settings
    delete :clear_credentials
  end
end
```

**Verification:**
- Run: `bin/rails routes | grep plugin`
- Should show configure, update_credentials, update_settings, clear_credentials routes

### Task 3: Add translation keys for configuration

**File:** `config/locales/en.yml` (modify existing)

Add under `flash.plugins`:

```yaml
credentials_saved: "Credentials saved successfully."
credentials_cleared: "Credentials cleared successfully."
settings_saved: "Settings saved successfully."
```

Add under `pages.plugins`:

```yaml
configuration:
  title: "Configure %{name}"
  subtitle: "Set up credentials and settings for this plugin"
  credentialsSection: "Credentials"
  credentialsDescription: "API keys and authentication details"
  settingsSection: "Settings"
  settingsDescription: "Plugin behavior and preferences"
  saveCredentials: "Save Credentials"
  saveSettings: "Save Settings"
  clearCredentials: "Clear Credentials"
  clearCredentialsConfirm: "Are you sure you want to clear all credentials? The plugin will stop working until new credentials are provided."
  backToPlugins: "Back to Plugins"
  noCredentials: "No credentials configured"
  credentialsMasked: "Credentials are stored securely. Values shown are masked."
```

**File:** `config/locales/cs.yml` (modify existing)

Add under `flash.plugins`:

```yaml
credentials_saved: "Prihlasovaci udaje ulozeny."
credentials_cleared: "Prihlasovaci udaje smazany."
settings_saved: "Nastaveni ulozeno."
```

Add under `pages.plugins`:

```yaml
configuration:
  title: "Nastaveni %{name}"
  subtitle: "Nastavte prihlasovaci udaje a preference pluginu"
  credentialsSection: "Prihlasovaci udaje"
  credentialsDescription: "API klice a autentizacni udaje"
  settingsSection: "Nastaveni"
  settingsDescription: "Chovani a preference pluginu"
  saveCredentials: "Ulozit udaje"
  saveSettings: "Ulozit nastaveni"
  clearCredentials: "Smazat udaje"
  clearCredentialsConfirm: "Opravdu chcete smazat vsechny prihlasovaci udaje? Plugin prestane fungovat dokud nebudou zadany nove."
  backToPlugins: "Zpet na pluginy"
  noCredentials: "Zadne prihlasovaci udaje"
  credentialsMasked: "Prihlasovaci udaje jsou bezpecne ulozeny. Zobrazene hodnoty jsou maskovane."
```

**Verification:**
- YAML files are valid

### Task 4: Create Plugins/Configure.tsx page component

**File:** `app/frontend/pages/Plugins/Configure.tsx`

```tsx
import { Head, usePage, router, Link } from "@inertiajs/react";
import { useEffect, useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useTranslation } from "react-i18next";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Toaster } from "@/components/ui/sonner";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";

interface FieldDefinition {
  name: string;
  label: string;
  type: "text" | "password" | "number" | "date" | "email";
  required: boolean;
  placeholder?: string;
  description?: string;
}

interface Plugin {
  plugin_name: string;
  plugin_version: string;
  plugin_description: string;
  enabled: boolean;
  configured: boolean;
}

interface PageProps {
  plugin: Plugin;
  credentials: Record<string, string>;
  settings: Record<string, string | number>;
  credential_fields: FieldDefinition[];
  setting_fields: FieldDefinition[];
  flash: {
    alert?: string;
    notice?: string;
  };
  [key: string]: unknown;
}

// Build Zod schema from field definitions
function buildSchema(fields: FieldDefinition[]) {
  const shape: Record<string, z.ZodTypeAny> = {};

  fields.forEach((field) => {
    let fieldSchema: z.ZodTypeAny;

    switch (field.type) {
      case "number":
        fieldSchema = z.coerce.number().optional();
        break;
      case "date":
        fieldSchema = z.string().optional();
        break;
      case "email":
        fieldSchema = field.required
          ? z.string().email()
          : z.string().email().optional().or(z.literal(""));
        break;
      default:
        fieldSchema = field.required
          ? z.string().min(1, `${field.label} is required`)
          : z.string().optional();
    }

    shape[field.name] = fieldSchema;
  });

  return z.object(shape);
}

function CredentialsForm({
  fields,
  defaultValues,
  pluginName,
}: {
  fields: FieldDefinition[];
  defaultValues: Record<string, string>;
  pluginName: string;
}) {
  const { t } = useTranslation();
  const [isSubmitting, setIsSubmitting] = useState(false);

  const schema = buildSchema(fields);
  type FormData = z.infer<typeof schema>;

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<FormData>({
    resolver: zodResolver(schema),
    defaultValues: Object.fromEntries(
      fields.map((f) => [f.name, ""])
    ) as FormData,
  });

  const onSubmit = (data: FormData) => {
    setIsSubmitting(true);
    router.patch(
      `/plugins/${pluginName}/update_credentials`,
      { credentials: data },
      {
        preserveScroll: true,
        onFinish: () => setIsSubmitting(false),
      }
    );
  };

  const hasCredentials = Object.values(defaultValues).some(
    (v) => v && v !== ""
  );

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      {hasCredentials && (
        <div className="p-3 bg-stone-50 rounded-lg text-sm text-stone-600">
          {t("pages.plugins.configuration.credentialsMasked")}
        </div>
      )}

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {fields.map((field) => (
          <div key={field.name} className="space-y-1.5">
            <Label
              htmlFor={`cred-${field.name}`}
              className="text-sm font-medium text-stone-700"
            >
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={`cred-${field.name}`}
              type={field.type}
              placeholder={
                field.placeholder ||
                (hasCredentials ? defaultValues[field.name] : "")
              }
              {...register(field.name)}
              className={`bg-stone-50 ${
                errors[field.name] ? "border-red-500" : ""
              }`}
            />
            {field.description && (
              <p className="text-xs text-stone-500">{field.description}</p>
            )}
            {errors[field.name] && (
              <p className="text-xs text-red-500">
                {errors[field.name]?.message as string}
              </p>
            )}
          </div>
        ))}
      </div>

      <div className="flex items-center gap-3 pt-2">
        <Button
          type="submit"
          disabled={isSubmitting}
          className="bg-stone-900 hover:bg-stone-800"
        >
          {isSubmitting
            ? t("common.saving")
            : t("pages.plugins.configuration.saveCredentials")}
        </Button>

        {hasCredentials && (
          <AlertDialog>
            <AlertDialogTrigger asChild>
              <Button type="button" variant="outline" className="text-red-600">
                {t("pages.plugins.configuration.clearCredentials")}
              </Button>
            </AlertDialogTrigger>
            <AlertDialogContent>
              <AlertDialogHeader>
                <AlertDialogTitle>
                  {t("pages.plugins.configuration.clearCredentials")}
                </AlertDialogTitle>
                <AlertDialogDescription>
                  {t("pages.plugins.configuration.clearCredentialsConfirm")}
                </AlertDialogDescription>
              </AlertDialogHeader>
              <AlertDialogFooter>
                <AlertDialogCancel>{t("common.cancel")}</AlertDialogCancel>
                <AlertDialogAction
                  onClick={() => {
                    router.delete(`/plugins/${pluginName}/clear_credentials`, {
                      preserveScroll: true,
                    });
                  }}
                  className="bg-red-600 hover:bg-red-700"
                >
                  {t("pages.plugins.configuration.clearCredentials")}
                </AlertDialogAction>
              </AlertDialogFooter>
            </AlertDialogContent>
          </AlertDialog>
        )}
      </div>
    </form>
  );
}

function SettingsForm({
  fields,
  defaultValues,
  pluginName,
}: {
  fields: FieldDefinition[];
  defaultValues: Record<string, string | number>;
  pluginName: string;
}) {
  const { t } = useTranslation();
  const [isSubmitting, setIsSubmitting] = useState(false);

  const schema = buildSchema(fields);
  type FormData = z.infer<typeof schema>;

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<FormData>({
    resolver: zodResolver(schema),
    defaultValues: defaultValues as FormData,
  });

  const onSubmit = (data: FormData) => {
    setIsSubmitting(true);
    router.patch(
      `/plugins/${pluginName}/update_settings`,
      { settings: data },
      {
        preserveScroll: true,
        onFinish: () => setIsSubmitting(false),
      }
    );
  };

  if (fields.length === 0) {
    return (
      <p className="text-sm text-stone-500 py-4">
        This plugin has no configurable settings.
      </p>
    );
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {fields.map((field) => (
          <div key={field.name} className="space-y-1.5">
            <Label
              htmlFor={`setting-${field.name}`}
              className="text-sm font-medium text-stone-700"
            >
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={`setting-${field.name}`}
              type={field.type}
              placeholder={field.placeholder}
              {...register(field.name)}
              className={`bg-stone-50 ${
                errors[field.name] ? "border-red-500" : ""
              }`}
            />
            {field.description && (
              <p className="text-xs text-stone-500">{field.description}</p>
            )}
            {errors[field.name] && (
              <p className="text-xs text-red-500">
                {errors[field.name]?.message as string}
              </p>
            )}
          </div>
        ))}
      </div>

      <div className="pt-2">
        <Button
          type="submit"
          disabled={isSubmitting}
          className="bg-stone-900 hover:bg-stone-800"
        >
          {isSubmitting
            ? t("common.saving")
            : t("pages.plugins.configuration.saveSettings")}
        </Button>
      </div>
    </form>
  );
}

export default function PluginsConfigure() {
  const { plugin, credentials, settings, credential_fields, setting_fields, flash } =
    usePage<PageProps>().props;
  const { t } = useTranslation();

  useEffect(() => {
    if (flash.notice) {
      toast.success(flash.notice);
    }
    if (flash.alert) {
      toast.error(flash.alert);
    }
  }, [flash.notice, flash.alert]);

  return (
    <>
      <Head
        title={t("pages.plugins.configuration.title", {
          name: plugin.plugin_name,
        })}
      />
      <Toaster position="top-right" />

      <div className="p-4 sm:p-6 lg:p-8">
        {/* Header */}
        <div className="mb-6 sm:mb-8">
          <Link
            href="/plugins"
            className="inline-flex items-center gap-1 text-sm text-stone-500 hover:text-stone-700 mb-4"
          >
            <svg
              className="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            {t("pages.plugins.configuration.backToPlugins")}
          </Link>
          <div className="flex items-center gap-3 mb-2">
            <h1 className="text-2xl font-semibold text-stone-900">
              {t("pages.plugins.configuration.title", {
                name: plugin.plugin_name,
              })}
            </h1>
            <span className="text-xs text-stone-500 bg-stone-100 px-2 py-0.5 rounded">
              v{plugin.plugin_version}
            </span>
          </div>
          <p className="text-stone-500">{plugin.plugin_description}</p>
        </div>

        <div className="max-w-2xl space-y-6">
          {/* Credentials Section */}
          <div className="bg-white rounded-xl border border-stone-200 p-6">
            <h3 className="font-semibold text-stone-900 mb-1">
              {t("pages.plugins.configuration.credentialsSection")}
            </h3>
            <p className="text-sm text-stone-500 mb-4">
              {t("pages.plugins.configuration.credentialsDescription")}
            </p>
            <CredentialsForm
              fields={credential_fields}
              defaultValues={credentials}
              pluginName={plugin.plugin_name}
            />
          </div>

          {/* Settings Section */}
          <div className="bg-white rounded-xl border border-stone-200 p-6">
            <h3 className="font-semibold text-stone-900 mb-1">
              {t("pages.plugins.configuration.settingsSection")}
            </h3>
            <p className="text-sm text-stone-500 mb-4">
              {t("pages.plugins.configuration.settingsDescription")}
            </p>
            <SettingsForm
              fields={setting_fields}
              defaultValues={settings}
              pluginName={plugin.plugin_name}
            />
          </div>
        </div>
      </div>
    </>
  );
}
```

**Verification:**
- No TypeScript errors: `npm run typecheck`

### Task 5: Add credential_fields and setting_fields to ExamplePlugin

Update the example plugin to define its configuration schema.

**File:** `app/plugins/example_plugin.rb` (modify existing)

Add class methods for field definitions:

```ruby
class ExamplePlugin < BasePlugin
  # ... existing code ...

  # Define credential fields for configuration UI
  # @return [Array<Hash>] field definitions
  def self.credential_fields
    [
      { name: "api_key", label: "API Key", type: "password", required: true,
        description: "Your API key from the external service" },
      { name: "account_id", label: "Account ID", type: "text", required: false,
        description: "Optional account identifier" }
    ]
  end

  # Define setting fields for configuration UI
  # @return [Array<Hash>] field definitions
  def self.setting_fields
    [
      { name: "sync_from_date", label: "Sync from date", type: "date", required: false,
        description: "Only import transactions after this date" },
      { name: "import_limit", label: "Import limit", type: "number", required: false,
        description: "Maximum number of records to import per sync" }
    ]
  end
end
```

**Verification:**
- No syntax errors: `ruby -c app/plugins/example_plugin.rb`

### Task 6: Write request specs for configuration actions

**File:** `spec/requests/plugins_controller_configure_spec.rb`

```ruby
require "rails_helper"

RSpec.describe "PluginsController Configuration", type: :request do
  let(:plugin_name) { "example" }

  before do
    # Authenticate as test user
    user = User.first || create(:user)
    post session_path, params: { email: user.email, password: "password" }
  end

  describe "GET /plugins/:id/configure" do
    it "renders the configuration page" do
      get configure_plugin_path(plugin_name)

      expect(response).to have_http_status(:success)
      expect(response.body).to include("Plugins/Configure")
    end

    it "includes credential fields in props" do
      get configure_plugin_path(plugin_name)

      # The response should include credential field definitions
      expect(response.body).to include("api_key")
    end

    context "with invalid plugin name" do
      it "redirects with error" do
        get configure_plugin_path("nonexistent")

        expect(response).to redirect_to(plugins_path)
        expect(flash[:alert]).to include("not found")
      end
    end
  end

  describe "PATCH /plugins/:id/update_credentials" do
    it "saves credentials" do
      patch update_credentials_plugin_path(plugin_name), params: {
        credentials: { api_key: "new_secret_key", account_id: "acc_123" }
      }

      expect(response).to redirect_to(configure_plugin_path(plugin_name))
      expect(flash[:notice]).to include("saved")

      config = PluginConfiguration.find_by(plugin_name: plugin_name)
      expect(config.credentials_hash["api_key"]).to eq("new_secret_key")
      expect(config.credentials_hash["account_id"]).to eq("acc_123")
    end

    it "replaces existing credentials" do
      create(:plugin_configuration,
             plugin_name: plugin_name,
             credentials: { old_key: "old_value" }.to_json)

      patch update_credentials_plugin_path(plugin_name), params: {
        credentials: { api_key: "new_key" }
      }

      config = PluginConfiguration.find_by(plugin_name: plugin_name)
      expect(config.credentials_hash["api_key"]).to eq("new_key")
      expect(config.credentials_hash["old_key"]).to be_nil
    end
  end

  describe "PATCH /plugins/:id/update_settings" do
    it "saves settings" do
      patch update_settings_plugin_path(plugin_name), params: {
        settings: { sync_from_date: "2026-01-01", import_limit: "100" }
      }

      expect(response).to redirect_to(configure_plugin_path(plugin_name))
      expect(flash[:notice]).to include("saved")

      config = PluginConfiguration.find_by(plugin_name: plugin_name)
      expect(config.settings_hash["sync_from_date"]).to eq("2026-01-01")
      expect(config.settings_hash["import_limit"]).to eq("100")
    end
  end

  describe "DELETE /plugins/:id/clear_credentials" do
    before do
      create(:plugin_configuration,
             plugin_name: plugin_name,
             credentials: { api_key: "secret" }.to_json)
    end

    it "clears all credentials" do
      delete clear_credentials_plugin_path(plugin_name)

      expect(response).to redirect_to(configure_plugin_path(plugin_name))
      expect(flash[:notice]).to include("cleared")

      config = PluginConfiguration.find_by(plugin_name: plugin_name)
      expect(config.credentials).to be_nil
    end
  end
end
```

**Verification:**
- Run: `bundle exec rspec spec/requests/plugins_controller_configure_spec.rb`
- All examples pass

### Task 7: Write frontend component test

**File:** `app/frontend/pages/Plugins/__tests__/Configure.test.tsx`

```tsx
import { render, screen } from "@testing-library/react";
import { describe, it, expect, vi } from "vitest";

// Mock Inertia
vi.mock("@inertiajs/react", () => ({
  Head: ({ title }: { title: string }) => <title>{title}</title>,
  usePage: () => ({
    props: {
      plugin: {
        plugin_name: "example",
        plugin_version: "1.0.0",
        plugin_description: "Example plugin",
        enabled: true,
        configured: false,
      },
      credentials: {},
      settings: {},
      credential_fields: [
        { name: "api_key", label: "API Key", type: "password", required: true },
      ],
      setting_fields: [
        { name: "import_limit", label: "Import limit", type: "number", required: false },
      ],
      flash: {},
    },
  }),
  router: {
    patch: vi.fn(),
    delete: vi.fn(),
  },
  Link: ({ href, children }: { href: string; children: React.ReactNode }) => (
    <a href={href}>{children}</a>
  ),
}));

// Mock i18n
vi.mock("react-i18next", () => ({
  useTranslation: () => ({
    t: (key: string, params?: Record<string, string>) => {
      if (params?.name) return `Configure ${params.name}`;
      return key;
    },
  }),
}));

// Mock sonner
vi.mock("sonner", () => ({
  toast: { success: vi.fn(), error: vi.fn() },
}));

// Import after mocks
import PluginsConfigure from "../Configure";

describe("PluginsConfigure", () => {
  it("renders plugin name and version", () => {
    render(<PluginsConfigure />);

    expect(screen.getByText("Configure example")).toBeInTheDocument();
    expect(screen.getByText("v1.0.0")).toBeInTheDocument();
  });

  it("renders credential fields", () => {
    render(<PluginsConfigure />);

    expect(screen.getByLabelText(/API Key/)).toBeInTheDocument();
  });

  it("renders setting fields", () => {
    render(<PluginsConfigure />);

    expect(screen.getByLabelText(/Import limit/)).toBeInTheDocument();
  });

  it("renders back link", () => {
    render(<PluginsConfigure />);

    const backLink = screen.getByRole("link", {
      name: /pages.plugins.configuration.backToPlugins/i,
    });
    expect(backLink).toHaveAttribute("href", "/plugins");
  });
});
```

**Verification:**
- Run: `npm run test:run -- app/frontend/pages/Plugins/__tests__/Configure.test.tsx`
- All tests pass

## Acceptance Criteria

- [ ] `configure` action renders Plugins/Configure page
- [ ] `update_credentials` action saves credentials via PluginConfigurationService
- [ ] `update_settings` action saves settings via PluginConfigurationService
- [ ] `clear_credentials` action clears all stored credentials
- [ ] Credentials are masked when displayed (last 4 chars visible)
- [ ] Forms use react-hook-form with Zod validation
- [ ] Credential fields use password type for sensitive data
- [ ] Plugin can define custom credential_fields and setting_fields
- [ ] All routes work: configure, update_credentials, update_settings, clear_credentials
- [ ] Flash messages displayed via toast notifications
- [ ] All specs pass

## Rollback Plan

If issues are found:
1. Revert controller changes
2. Revert route changes
3. Remove `app/frontend/pages/Plugins/Configure.tsx`
4. Revert ExamplePlugin changes
5. Revert locale changes
6. Remove spec files

## Notes

- Credentials are stored encrypted via Rails 7+ attribute encryption
- Masked credentials show `****` prefix with last 4 characters visible
- Forms use `replace_credentials` and `replace_settings` to avoid partial updates
- Clear credentials requires confirmation dialog to prevent accidental data loss
- Plugin classes can define their own credential_fields and setting_fields
- Default fields provided for plugins that don't define custom fields
