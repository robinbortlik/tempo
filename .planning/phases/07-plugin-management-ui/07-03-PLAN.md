---
phase: 07-plugin-management-ui
plan: 03
title: Sync history display
subsystem: frontend
tags: [react, typescript, inertia, controller, serializer]

# Dependency graph
requires:
  - phase: 07-plugin-management-ui
    plan: 01
    provides: [PluginsController, routes]
  - phase: 05-sync-engine
    provides: [SyncHistory model, stats_for_plugin, summary method]
  - phase: 06-audit-trail
    provides: [DataAuditLog model, audit entries per sync]
provides:
  - Plugins/History.tsx page component
  - Sync history list with filtering
  - Sync detail view with audit entries
  - SyncHistorySerializer for JSON transformation
affects: []

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Table component for history list"
    - "Collapsible sections for sync details"
    - "Status badges for sync outcomes"
---

# Plan: Sync History Display

**Goal:** Create sync history display showing all sync operations per plugin with details and audit trail

## Context

### From Plan 07-01
- `PluginsController` exists with plugin management actions
- Plugin cards show last sync status and stats
- Routes exist for `/plugins`

### From Phase 5 (Sync Engine)
- `SyncHistory` model tracks sync operations with:
  - `status` (pending, running, completed, failed)
  - `started_at`, `completed_at`
  - `records_processed`, `records_created`, `records_updated`
  - `error_message`
- `SyncHistory.stats_for_plugin(name)` returns aggregate statistics
- `SyncHistory#summary` returns hash for UI display
- `SyncHistory#duration_formatted` returns human-readable duration

### From Phase 6 (Audit Trail)
- `DataAuditLog` tracks changes made during sync operations
- `DataAuditLog.for_sync(sync_history_id)` returns audit entries for a sync
- `DataAuditLog#summary` returns hash for UI display

### Existing Patterns
- Table component available at `@/components/ui/table`
- Collapsible component available at `@/components/ui/collapsible`
- Status badges with color-coded backgrounds

### This Plan Adds

1. `history` action to PluginsController
2. `SyncHistorySerializer` for JSON transformation
3. `Plugins/History.tsx` page component
4. Link from plugin list to history view

## Tasks

### Task 1: Create SyncHistorySerializer

Create Alba serializer for sync history data.

**File:** `app/serializers/sync_history_serializer.rb`

```ruby
class SyncHistorySerializer
  include Alba::Resource

  attributes :id, :plugin_name, :status,
             :records_processed, :records_created, :records_updated,
             :error_message

  attribute :started_at do |history|
    history.started_at&.iso8601
  end

  attribute :completed_at do |history|
    history.completed_at&.iso8601
  end

  attribute :duration do |history|
    history.duration
  end

  attribute :duration_formatted do |history|
    history.duration_formatted
  end

  attribute :successful do |history|
    history.successful?
  end

  # List variant - for history list view
  class List
    include Alba::Resource

    attributes :id, :status,
               :records_processed, :records_created, :records_updated,
               :error_message

    attribute :started_at do |history|
      history.started_at&.iso8601
    end

    attribute :completed_at do |history|
      history.completed_at&.iso8601
    end

    attribute :duration_formatted do |history|
      history.duration_formatted
    end

    attribute :successful do |history|
      history.successful?
    end
  end

  # Detail variant - includes audit entries
  class Detail
    include Alba::Resource

    attributes :id, :plugin_name, :status,
               :records_processed, :records_created, :records_updated,
               :error_message

    attribute :started_at do |history|
      history.started_at&.iso8601
    end

    attribute :completed_at do |history|
      history.completed_at&.iso8601
    end

    attribute :duration do |history|
      history.duration
    end

    attribute :duration_formatted do |history|
      history.duration_formatted
    end

    attribute :successful do |history|
      history.successful?
    end

    attribute :audit_entries do |history|
      DataAuditLog.for_sync(history.id).order(created_at: :asc).map(&:summary)
    end
  end
end
```

**Verification:**
- No syntax errors: `ruby -c app/serializers/sync_history_serializer.rb`

### Task 2: Add history action to PluginsController

Extend the controller with history and show_sync actions.

**File:** `app/controllers/plugins_controller.rb` (modify existing)

Add `set_plugin_name` to the before_action list for history and show_sync:

```ruby
before_action :set_plugin_name, only: [:enable, :disable, :sync, :configure, :update_credentials, :update_settings, :clear_credentials, :history, :show_sync]
```

Add after configure actions:

```ruby
def history
  service = PluginConfigurationService.new(plugin_name: @plugin_name)
  sync_histories = SyncHistory.for_plugin(@plugin_name)
                              .order(created_at: :desc)
                              .limit(50)

  render inertia: "Plugins/History", props: {
    plugin: PluginSerializer.new(service.summary).serializable_hash,
    sync_histories: SyncHistorySerializer::List.new(sync_histories).serializable_hash,
    stats: SyncHistory.stats_for_plugin(@plugin_name),
    aggregate_stats: SyncHistory.aggregate_stats
  }
rescue PluginRegistry::NotFoundError => e
  redirect_to plugins_path, alert: e.message
end

def show_sync
  sync_history = SyncHistory.find(params[:sync_id])

  # Verify sync belongs to the plugin
  unless sync_history.plugin_name == @plugin_name
    redirect_to history_plugin_path(@plugin_name), alert: t("flash.plugins.sync_not_found")
    return
  end

  service = PluginConfigurationService.new(plugin_name: @plugin_name)

  render inertia: "Plugins/SyncDetail", props: {
    plugin: PluginSerializer.new(service.summary).serializable_hash,
    sync_history: SyncHistorySerializer::Detail.new(sync_history).serializable_hash
  }
rescue ActiveRecord::RecordNotFound
  redirect_to history_plugin_path(@plugin_name), alert: t("flash.plugins.sync_not_found")
rescue PluginRegistry::NotFoundError => e
  redirect_to plugins_path, alert: e.message
end
```

**Verification:**
- No syntax errors: `ruby -c app/controllers/plugins_controller.rb`

### Task 3: Update routes for history actions

**File:** `config/routes.rb` (modify existing)

Update the plugins resource:

```ruby
resources :plugins, only: [:index] do
  member do
    patch :enable
    patch :disable
    post :sync
    get :configure
    patch :update_credentials
    patch :update_settings
    delete :clear_credentials
    get :history
    get "sync/:sync_id", action: :show_sync, as: :show_sync
  end
end
```

**Verification:**
- Run: `bin/rails routes | grep plugin`
- Should show history and show_sync routes

### Task 4: Add translation keys for history

**File:** `config/locales/en.yml` (modify existing)

Add under `flash.plugins`:

```yaml
sync_not_found: "Sync history not found."
```

Add under `pages.plugins`:

```yaml
history:
  title: "Sync History - %{name}"
  subtitle: "View past sync operations and their results"
  backToPlugins: "Back to Plugins"
  noHistory: "No sync history"
  noHistoryDescription: "Sync operations will appear here once you run your first sync."
  stats:
    totalSyncs: "Total Syncs"
    successRate: "Success Rate"
    averageDuration: "Avg Duration"
    recordsProcessed: "Records Processed"
  table:
    date: "Date"
    status: "Status"
    duration: "Duration"
    records: "Records"
    error: "Error"
    actions: "Actions"
  viewDetails: "View Details"
syncDetail:
  title: "Sync Details"
  backToHistory: "Back to History"
  summary: "Summary"
  auditTrail: "Changes Made"
  noChanges: "No data changes recorded for this sync."
  recordsProcessed: "Records Processed"
  recordsCreated: "Records Created"
  recordsUpdated: "Records Updated"
  startedAt: "Started"
  completedAt: "Completed"
  duration: "Duration"
  auditEntry:
    created: "Created"
    updated: "Updated"
    destroyed: "Destroyed"
```

**File:** `config/locales/cs.yml` (modify existing)

Add under `flash.plugins`:

```yaml
sync_not_found: "Historie synchronizace nenalezena."
```

Add under `pages.plugins`:

```yaml
history:
  title: "Historie synchronizace - %{name}"
  subtitle: "Zobrazit predchozi synchronizace a jejich vysledky"
  backToPlugins: "Zpet na pluginy"
  noHistory: "Zadna historie"
  noHistoryDescription: "Synchronizace se zobrazi po spusteni prvni synchronizace."
  stats:
    totalSyncs: "Celkem syncu"
    successRate: "Uspesnost"
    averageDuration: "Prumerna doba"
    recordsProcessed: "Zpracovano zaznamu"
  table:
    date: "Datum"
    status: "Stav"
    duration: "Doba"
    records: "Zaznamy"
    error: "Chyba"
    actions: "Akce"
  viewDetails: "Zobrazit detaily"
syncDetail:
  title: "Detail synchronizace"
  backToHistory: "Zpet na historii"
  summary: "Souhrn"
  auditTrail: "Provedene zmeny"
  noChanges: "Pro tuto synchronizaci nebyly zaznamenany zadne zmeny."
  recordsProcessed: "Zpracovano zaznamu"
  recordsCreated: "Vytvoreno zaznamu"
  recordsUpdated: "Aktualizovano zaznamu"
  startedAt: "Zahajeno"
  completedAt: "Dokonceno"
  duration: "Doba"
  auditEntry:
    created: "Vytvoreno"
    updated: "Aktualizovano"
    destroyed: "Smazano"
```

**Verification:**
- YAML files are valid

### Task 5: Create Plugins/History.tsx page component

**File:** `app/frontend/pages/Plugins/History.tsx`

```tsx
import { Head, usePage, router, Link } from "@inertiajs/react";
import { useEffect } from "react";
import { useTranslation } from "react-i18next";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { Toaster } from "@/components/ui/sonner";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";

interface SyncHistory {
  id: number;
  status: string;
  started_at: string | null;
  completed_at: string | null;
  duration_formatted: string | null;
  records_processed: number;
  records_created: number;
  records_updated: number;
  error_message: string | null;
  successful: boolean;
}

interface Plugin {
  plugin_name: string;
  plugin_version: string;
  plugin_description: string;
  enabled: boolean;
  configured: boolean;
}

interface Stats {
  total_syncs: number;
  successful_syncs: number;
  failed_syncs: number;
  success_rate: number;
  average_duration: number | null;
  total_records_processed: number;
}

interface PageProps {
  plugin: Plugin;
  sync_histories: SyncHistory[];
  stats: Stats;
  flash: {
    alert?: string;
    notice?: string;
  };
  [key: string]: unknown;
}

function getStatusBadgeClass(status: string): string {
  switch (status) {
    case "completed":
      return "bg-green-100 text-green-700";
    case "failed":
      return "bg-red-100 text-red-700";
    case "running":
      return "bg-blue-100 text-blue-700";
    case "pending":
      return "bg-amber-100 text-amber-700";
    default:
      return "bg-stone-100 text-stone-600";
  }
}

function formatDate(dateString: string | null): string {
  if (!dateString) return "-";
  const date = new Date(dateString);
  return date.toLocaleDateString(undefined, {
    month: "short",
    day: "numeric",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}

function formatDuration(seconds: number | null): string {
  if (!seconds) return "-";
  if (seconds < 60) return `${seconds.toFixed(1)}s`;
  const minutes = Math.floor(seconds / 60);
  const secs = Math.round(seconds % 60);
  return `${minutes}m ${secs}s`;
}

function StatCard({
  label,
  value,
  subValue,
}: {
  label: string;
  value: string | number;
  subValue?: string;
}) {
  return (
    <div className="bg-white rounded-xl border border-stone-200 p-4">
      <p className="text-sm text-stone-500 mb-1">{label}</p>
      <p className="text-2xl font-semibold text-stone-900">{value}</p>
      {subValue && <p className="text-xs text-stone-500 mt-1">{subValue}</p>}
    </div>
  );
}

export default function PluginsHistory() {
  const { plugin, sync_histories, stats, flash } = usePage<PageProps>().props;
  const { t } = useTranslation();

  useEffect(() => {
    if (flash.notice) {
      toast.success(flash.notice);
    }
    if (flash.alert) {
      toast.error(flash.alert);
    }
  }, [flash.notice, flash.alert]);

  const handleViewDetails = (syncId: number) => {
    router.visit(`/plugins/${plugin.plugin_name}/sync/${syncId}`);
  };

  return (
    <>
      <Head
        title={t("pages.plugins.history.title", { name: plugin.plugin_name })}
      />
      <Toaster position="top-right" />

      <div className="p-4 sm:p-6 lg:p-8">
        {/* Header */}
        <div className="mb-6 sm:mb-8">
          <Link
            href="/plugins"
            className="inline-flex items-center gap-1 text-sm text-stone-500 hover:text-stone-700 mb-4"
          >
            <svg
              className="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            {t("pages.plugins.history.backToPlugins")}
          </Link>
          <h1 className="text-2xl font-semibold text-stone-900">
            {t("pages.plugins.history.title", { name: plugin.plugin_name })}
          </h1>
          <p className="text-stone-500 mt-1">
            {t("pages.plugins.history.subtitle")}
          </p>
        </div>

        {/* Stats Grid */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <StatCard
            label={t("pages.plugins.history.stats.totalSyncs")}
            value={stats.total_syncs}
            subValue={`${stats.successful_syncs} successful, ${stats.failed_syncs} failed`}
          />
          <StatCard
            label={t("pages.plugins.history.stats.successRate")}
            value={`${stats.success_rate.toFixed(1)}%`}
          />
          <StatCard
            label={t("pages.plugins.history.stats.averageDuration")}
            value={formatDuration(stats.average_duration)}
          />
          <StatCard
            label={t("pages.plugins.history.stats.recordsProcessed")}
            value={stats.total_records_processed.toLocaleString()}
          />
        </div>

        {/* History Table */}
        {sync_histories.length === 0 ? (
          <div className="bg-white rounded-xl border border-stone-200 p-8 text-center">
            <div className="w-12 h-12 mx-auto mb-4 bg-stone-100 rounded-lg flex items-center justify-center">
              <svg
                className="w-6 h-6 text-stone-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="1.5"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </div>
            <h3 className="font-medium text-stone-900 mb-1">
              {t("pages.plugins.history.noHistory")}
            </h3>
            <p className="text-sm text-stone-500">
              {t("pages.plugins.history.noHistoryDescription")}
            </p>
          </div>
        ) : (
          <div className="bg-white rounded-xl border border-stone-200 overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow className="text-left text-sm text-stone-500 border-b border-stone-200">
                  <TableHead className="px-6 py-4 font-medium">
                    {t("pages.plugins.history.table.date")}
                  </TableHead>
                  <TableHead className="px-6 py-4 font-medium">
                    {t("pages.plugins.history.table.status")}
                  </TableHead>
                  <TableHead className="px-6 py-4 font-medium text-right">
                    {t("pages.plugins.history.table.duration")}
                  </TableHead>
                  <TableHead className="px-6 py-4 font-medium text-right">
                    {t("pages.plugins.history.table.records")}
                  </TableHead>
                  <TableHead className="hidden md:table-cell px-6 py-4 font-medium">
                    {t("pages.plugins.history.table.error")}
                  </TableHead>
                  <TableHead className="px-6 py-4 font-medium">
                    {t("pages.plugins.history.table.actions")}
                  </TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {sync_histories.map((history) => (
                  <TableRow
                    key={history.id}
                    className="border-b border-stone-100 hover:bg-stone-50 transition-colors"
                  >
                    <TableCell className="px-6 py-4 text-stone-900">
                      {formatDate(history.started_at)}
                    </TableCell>
                    <TableCell className="px-6 py-4">
                      <span
                        className={`px-2 py-1 rounded text-xs font-medium ${getStatusBadgeClass(
                          history.status
                        )}`}
                      >
                        {history.status}
                      </span>
                    </TableCell>
                    <TableCell className="px-6 py-4 text-right text-stone-600 tabular-nums">
                      {history.duration_formatted || "-"}
                    </TableCell>
                    <TableCell className="px-6 py-4 text-right">
                      <span className="text-stone-900 font-medium">
                        {history.records_processed}
                      </span>
                      {history.records_created > 0 && (
                        <span className="text-green-600 ml-2 text-sm">
                          +{history.records_created}
                        </span>
                      )}
                      {history.records_updated > 0 && (
                        <span className="text-blue-600 ml-1 text-sm">
                          ~{history.records_updated}
                        </span>
                      )}
                    </TableCell>
                    <TableCell className="hidden md:table-cell px-6 py-4 text-stone-500 max-w-xs truncate">
                      {history.error_message || "-"}
                    </TableCell>
                    <TableCell className="px-6 py-4">
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handleViewDetails(history.id)}
                        className="text-stone-600"
                      >
                        {t("pages.plugins.history.viewDetails")}
                      </Button>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </div>
        )}
      </div>
    </>
  );
}
```

**Verification:**
- No TypeScript errors: `npm run typecheck`

### Task 6: Create Plugins/SyncDetail.tsx page component

**File:** `app/frontend/pages/Plugins/SyncDetail.tsx`

```tsx
import { Head, usePage, Link } from "@inertiajs/react";
import { useEffect } from "react";
import { useTranslation } from "react-i18next";
import { toast } from "sonner";
import { Toaster } from "@/components/ui/sonner";

interface AuditEntry {
  id: number;
  auditable_type: string;
  auditable_id: number;
  action: string;
  source: string;
  changes_made: Record<string, { from: unknown; to: unknown } | unknown>;
  description: string;
  created_at: string;
}

interface SyncHistory {
  id: number;
  plugin_name: string;
  status: string;
  started_at: string | null;
  completed_at: string | null;
  duration: number | null;
  duration_formatted: string | null;
  records_processed: number;
  records_created: number;
  records_updated: number;
  error_message: string | null;
  successful: boolean;
  audit_entries: AuditEntry[];
}

interface Plugin {
  plugin_name: string;
  plugin_version: string;
  plugin_description: string;
}

interface PageProps {
  plugin: Plugin;
  sync_history: SyncHistory;
  flash: {
    alert?: string;
    notice?: string;
  };
  [key: string]: unknown;
}

function getStatusBadgeClass(status: string): string {
  switch (status) {
    case "completed":
      return "bg-green-100 text-green-700";
    case "failed":
      return "bg-red-100 text-red-700";
    case "running":
      return "bg-blue-100 text-blue-700";
    case "pending":
      return "bg-amber-100 text-amber-700";
    default:
      return "bg-stone-100 text-stone-600";
  }
}

function getActionBadgeClass(action: string): string {
  switch (action) {
    case "create":
      return "bg-green-100 text-green-700";
    case "update":
      return "bg-blue-100 text-blue-700";
    case "destroy":
      return "bg-red-100 text-red-700";
    default:
      return "bg-stone-100 text-stone-600";
  }
}

function formatDateTime(dateString: string | null): string {
  if (!dateString) return "-";
  const date = new Date(dateString);
  return date.toLocaleDateString(undefined, {
    month: "short",
    day: "numeric",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  });
}

function formatTime(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleTimeString(undefined, {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
  });
}

function SummaryItem({
  label,
  value,
  className = "",
}: {
  label: string;
  value: string | number;
  className?: string;
}) {
  return (
    <div className="flex justify-between items-center py-2 border-b border-stone-100 last:border-0">
      <span className="text-stone-500">{label}</span>
      <span className={`font-medium ${className}`}>{value}</span>
    </div>
  );
}

function AuditEntryCard({ entry }: { entry: AuditEntry }) {
  const { t } = useTranslation();

  const actionLabel =
    entry.action === "create"
      ? t("pages.plugins.syncDetail.auditEntry.created")
      : entry.action === "update"
        ? t("pages.plugins.syncDetail.auditEntry.updated")
        : t("pages.plugins.syncDetail.auditEntry.destroyed");

  return (
    <div className="border border-stone-200 rounded-lg p-4">
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <span
            className={`px-2 py-0.5 rounded text-xs font-medium ${getActionBadgeClass(
              entry.action
            )}`}
          >
            {actionLabel}
          </span>
          <span className="text-stone-900 font-medium">
            {entry.auditable_type} #{entry.auditable_id}
          </span>
        </div>
        <span className="text-xs text-stone-500">
          {formatTime(entry.created_at)}
        </span>
      </div>

      {entry.changes_made && Object.keys(entry.changes_made).length > 0 && (
        <div className="mt-2 text-sm">
          {Object.entries(entry.changes_made).map(([key, value]) => {
            if (key === "final_state") {
              // For destroy actions, show final state
              return (
                <div key={key} className="text-stone-500 text-xs mt-1">
                  Final state preserved
                </div>
              );
            }

            const change = value as { from: unknown; to: unknown };
            return (
              <div key={key} className="flex items-center gap-2 text-stone-600">
                <span className="font-mono text-xs bg-stone-100 px-1 rounded">
                  {key}
                </span>
                <span className="text-stone-400">:</span>
                <span className="text-red-600 line-through text-xs">
                  {String(change.from ?? "null")}
                </span>
                <span className="text-stone-400">-&gt;</span>
                <span className="text-green-600 text-xs">
                  {String(change.to ?? "null")}
                </span>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

export default function PluginsSyncDetail() {
  const { plugin, sync_history, flash } = usePage<PageProps>().props;
  const { t } = useTranslation();

  useEffect(() => {
    if (flash.notice) {
      toast.success(flash.notice);
    }
    if (flash.alert) {
      toast.error(flash.alert);
    }
  }, [flash.notice, flash.alert]);

  return (
    <>
      <Head title={t("pages.plugins.syncDetail.title")} />
      <Toaster position="top-right" />

      <div className="p-4 sm:p-6 lg:p-8">
        {/* Header */}
        <div className="mb-6 sm:mb-8">
          <Link
            href={`/plugins/${plugin.plugin_name}/history`}
            className="inline-flex items-center gap-1 text-sm text-stone-500 hover:text-stone-700 mb-4"
          >
            <svg
              className="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            {t("pages.plugins.syncDetail.backToHistory")}
          </Link>
          <div className="flex items-center gap-3">
            <h1 className="text-2xl font-semibold text-stone-900">
              {t("pages.plugins.syncDetail.title")}
            </h1>
            <span
              className={`px-2 py-1 rounded text-sm font-medium ${getStatusBadgeClass(
                sync_history.status
              )}`}
            >
              {sync_history.status}
            </span>
          </div>
          <p className="text-stone-500 mt-1">
            {plugin.plugin_name} - Sync #{sync_history.id}
          </p>
        </div>

        <div className="max-w-3xl space-y-6">
          {/* Summary Section */}
          <div className="bg-white rounded-xl border border-stone-200 p-6">
            <h3 className="font-semibold text-stone-900 mb-4">
              {t("pages.plugins.syncDetail.summary")}
            </h3>

            <div className="space-y-1">
              <SummaryItem
                label={t("pages.plugins.syncDetail.startedAt")}
                value={formatDateTime(sync_history.started_at)}
              />
              <SummaryItem
                label={t("pages.plugins.syncDetail.completedAt")}
                value={formatDateTime(sync_history.completed_at)}
              />
              <SummaryItem
                label={t("pages.plugins.syncDetail.duration")}
                value={sync_history.duration_formatted || "-"}
              />
              <SummaryItem
                label={t("pages.plugins.syncDetail.recordsProcessed")}
                value={sync_history.records_processed}
              />
              <SummaryItem
                label={t("pages.plugins.syncDetail.recordsCreated")}
                value={sync_history.records_created}
                className="text-green-600"
              />
              <SummaryItem
                label={t("pages.plugins.syncDetail.recordsUpdated")}
                value={sync_history.records_updated}
                className="text-blue-600"
              />
            </div>

            {sync_history.error_message && (
              <div className="mt-4 p-3 bg-red-50 rounded-lg">
                <p className="text-sm font-medium text-red-800 mb-1">Error</p>
                <p className="text-sm text-red-700 font-mono">
                  {sync_history.error_message}
                </p>
              </div>
            )}
          </div>

          {/* Audit Trail Section */}
          <div className="bg-white rounded-xl border border-stone-200 p-6">
            <h3 className="font-semibold text-stone-900 mb-4">
              {t("pages.plugins.syncDetail.auditTrail")}
              {sync_history.audit_entries.length > 0 && (
                <span className="ml-2 text-sm font-normal text-stone-500">
                  ({sync_history.audit_entries.length} changes)
                </span>
              )}
            </h3>

            {sync_history.audit_entries.length === 0 ? (
              <p className="text-stone-500 text-sm py-4">
                {t("pages.plugins.syncDetail.noChanges")}
              </p>
            ) : (
              <div className="space-y-3">
                {sync_history.audit_entries.map((entry) => (
                  <AuditEntryCard key={entry.id} entry={entry} />
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </>
  );
}
```

**Verification:**
- No TypeScript errors: `npm run typecheck`

### Task 7: Add history link to plugin list

Update Plugins/Index.tsx to include a history link for each plugin.

**File:** `app/frontend/pages/Plugins/Index.tsx` (modify existing)

Add after the Configure button in the plugin card actions:

```tsx
{/* History button */}
<Button
  variant="outline"
  size="sm"
  onClick={() => router.visit(`/plugins/${plugin.plugin_name}/history`)}
  className="text-stone-600"
>
  {t("pages.plugins.viewHistory")}
</Button>
```

Add translation key:

**File:** `config/locales/en.yml` (modify existing)

Add under `pages.plugins`:

```yaml
viewHistory: "View History"
```

**File:** `config/locales/cs.yml` (modify existing)

Add under `pages.plugins`:

```yaml
viewHistory: "Zobrazit historii"
```

**Verification:**
- No TypeScript errors: `npm run typecheck`

### Task 8: Write request specs for history actions

**File:** `spec/requests/plugins_controller_history_spec.rb`

```ruby
require "rails_helper"

RSpec.describe "PluginsController History", type: :request do
  let(:plugin_name) { "example" }

  before do
    # Authenticate as test user
    user = User.first || create(:user)
    post session_path, params: { email: user.email, password: "password" }
  end

  describe "GET /plugins/:id/history" do
    it "renders the history page" do
      get history_plugin_path(plugin_name)

      expect(response).to have_http_status(:success)
      expect(response.body).to include("Plugins/History")
    end

    it "includes sync histories in props" do
      create(:sync_history, plugin_name: plugin_name, status: :completed)
      create(:sync_history, plugin_name: plugin_name, status: :failed)

      get history_plugin_path(plugin_name)

      expect(response).to have_http_status(:success)
    end

    it "includes stats in props" do
      3.times { create(:sync_history, plugin_name: plugin_name, status: :completed) }

      get history_plugin_path(plugin_name)

      expect(response).to have_http_status(:success)
    end

    context "with invalid plugin name" do
      it "redirects with error" do
        get history_plugin_path("nonexistent")

        expect(response).to redirect_to(plugins_path)
        expect(flash[:alert]).to include("not found")
      end
    end
  end

  describe "GET /plugins/:id/sync/:sync_id" do
    let!(:sync_history) { create(:sync_history, plugin_name: plugin_name, status: :completed) }

    it "renders the sync detail page" do
      get show_sync_plugin_path(plugin_name, sync_id: sync_history.id)

      expect(response).to have_http_status(:success)
      expect(response.body).to include("Plugins/SyncDetail")
    end

    it "includes audit entries in props" do
      create(:data_audit_log, sync_history: sync_history, source: plugin_name)

      get show_sync_plugin_path(plugin_name, sync_id: sync_history.id)

      expect(response).to have_http_status(:success)
    end

    context "when sync doesn't exist" do
      it "redirects with error" do
        get show_sync_plugin_path(plugin_name, sync_id: 99999)

        expect(response).to redirect_to(history_plugin_path(plugin_name))
        expect(flash[:alert]).to include("not found")
      end
    end

    context "when sync belongs to different plugin" do
      let!(:other_sync) { create(:sync_history, plugin_name: "other_plugin", status: :completed) }

      it "redirects with error" do
        get show_sync_plugin_path(plugin_name, sync_id: other_sync.id)

        expect(response).to redirect_to(history_plugin_path(plugin_name))
        expect(flash[:alert]).to include("not found")
      end
    end
  end
end
```

**Verification:**
- Run: `bundle exec rspec spec/requests/plugins_controller_history_spec.rb`
- All examples pass

### Task 9: Write serializer specs

**File:** `spec/serializers/sync_history_serializer_spec.rb`

```ruby
require "rails_helper"

RSpec.describe SyncHistorySerializer do
  let(:sync_history) do
    create(:sync_history,
           plugin_name: "example",
           status: :completed,
           started_at: 2.minutes.ago,
           completed_at: 1.minute.ago,
           records_processed: 10,
           records_created: 5,
           records_updated: 3)
  end

  describe SyncHistorySerializer::List do
    it "serializes sync history for list view" do
      result = described_class.new([sync_history]).serializable_hash

      history = result.first
      expect(history[:id]).to eq(sync_history.id)
      expect(history[:status]).to eq("completed")
      expect(history[:records_processed]).to eq(10)
      expect(history[:records_created]).to eq(5)
      expect(history[:records_updated]).to eq(3)
      expect(history[:successful]).to be true
      expect(history[:duration_formatted]).to be_present
    end
  end

  describe SyncHistorySerializer::Detail do
    before do
      create(:data_audit_log,
             sync_history: sync_history,
             source: "example",
             action: :create_action,
             auditable_type: "MoneyTransaction",
             auditable_id: 1)
    end

    it "serializes sync history with audit entries" do
      result = described_class.new(sync_history).serializable_hash

      expect(result[:id]).to eq(sync_history.id)
      expect(result[:plugin_name]).to eq("example")
      expect(result[:audit_entries]).to be_an(Array)
      expect(result[:audit_entries].length).to eq(1)
      expect(result[:audit_entries].first[:action]).to eq("create")
    end
  end
end
```

**Verification:**
- Run: `bundle exec rspec spec/serializers/sync_history_serializer_spec.rb`
- All examples pass

## Acceptance Criteria

- [ ] `history` action renders Plugins/History page with sync list
- [ ] `show_sync` action renders Plugins/SyncDetail page with audit entries
- [ ] `SyncHistorySerializer` with List and Detail variants
- [ ] History page shows stats grid (total syncs, success rate, avg duration)
- [ ] History table shows all sync operations with status badges
- [ ] Sync detail page shows summary and audit trail
- [ ] Audit entries show action type, record info, and changes
- [ ] Plugin list includes "View History" link
- [ ] Routes work: /plugins/:id/history, /plugins/:id/sync/:sync_id
- [ ] All specs pass

## Rollback Plan

If issues are found:
1. Revert controller changes
2. Remove `app/serializers/sync_history_serializer.rb`
3. Remove `app/frontend/pages/Plugins/History.tsx`
4. Remove `app/frontend/pages/Plugins/SyncDetail.tsx`
5. Revert route changes
6. Revert locale changes
7. Remove spec files

## Notes

- Sync history is limited to last 50 entries to prevent performance issues
- Audit entries are loaded via DataAuditLog.for_sync(sync_history_id)
- Stats calculated using SyncHistory.stats_for_plugin class method
- Status badges use consistent color scheme (green=completed, red=failed, blue=running, amber=pending)
- Duration formatted using SyncHistory#duration_formatted method
- Audit entries show change diffs in from/to format
- Error messages displayed prominently for failed syncs
