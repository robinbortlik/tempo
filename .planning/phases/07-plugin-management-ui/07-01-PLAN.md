---
phase: 07-plugin-management-ui
plan: 01
title: Plugin list and enable/disable UI
subsystem: frontend
tags: [react, typescript, inertia, controller, serializer]

# Dependency graph
requires:
  - phase: 06-audit-trail
    provides: [DataAuditLog model, audit context integration]
  - phase: 04-plugin-configuration
    provides: [PluginConfigurationService, enable/disable methods, all_plugins_summary]
  - phase: 03-plugin-registry
    provides: [PluginRegistry, metadata method]
provides:
  - PluginsController for backend API
  - PluginSerializer for JSON transformation
  - Plugins/Index.tsx page component
  - Plugin list with enable/disable toggles
  - Routes for /plugins
affects: [07-02, 07-03]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Inertia.js controller rendering"
    - "Alba serializer for JSON"
    - "React page component with TypeScript"
    - "Switch component for enable/disable"
---

# Plan: Plugin List and Enable/Disable UI

**Goal:** Create the PluginsController and Plugins/Index page to list all registered plugins with enable/disable toggles

## Context

### From Phase 3 (Plugin Registry)
- `PluginRegistry.all` returns array of all plugin classes
- `PluginRegistry.metadata` returns array of `{ name, version, description, class }`

### From Phase 4 (Plugin Configuration)
- `PluginConfigurationService.all_plugins_summary` returns plugin status for UI
- `PluginConfigurationService#enable!` and `disable!` toggle plugin state
- `PluginConfiguration` model stores enabled state per plugin

### From Phase 6 (Audit Trail)
- `SyncHistory.stats_for_plugin(name)` provides sync statistics per plugin

### Existing Patterns
- Controllers use `render inertia: "Resource/Page", props: { ... }`
- Alba serializers transform data for frontend
- Page components at `app/frontend/pages/{Resource}/{Action}.tsx`
- Switch component available at `@/components/ui/switch`

### This Plan Adds

1. `PluginsController` with index, enable, disable actions
2. `PluginSerializer` for JSON transformation
3. `Plugins/Index.tsx` page component
4. Routes for plugins resource

## Tasks

### Task 1: Create PluginSerializer

Create Alba serializer for plugin data.

**File:** `app/serializers/plugin_serializer.rb`

```ruby
class PluginSerializer
  include Alba::Resource

  # Full detail for single plugin
  attributes :plugin_name, :plugin_version, :plugin_description,
             :enabled, :configured, :has_settings

  attribute :created_at do |plugin_summary|
    plugin_summary[:created_at]&.iso8601
  end

  attribute :updated_at do |plugin_summary|
    plugin_summary[:updated_at]&.iso8601
  end

  # For list view - includes sync stats
  class List
    include Alba::Resource

    attributes :plugin_name, :plugin_version, :plugin_description,
               :enabled, :configured

    attribute :last_sync_at do |plugin_summary|
      params[:sync_stats]&.dig(plugin_summary[:plugin_name], :last_sync, :completed_at)
    end

    attribute :last_sync_status do |plugin_summary|
      params[:sync_stats]&.dig(plugin_summary[:plugin_name], :last_sync, :status)
    end

    attribute :total_syncs do |plugin_summary|
      params[:sync_stats]&.dig(plugin_summary[:plugin_name], :total_syncs) || 0
    end

    attribute :success_rate do |plugin_summary|
      params[:sync_stats]&.dig(plugin_summary[:plugin_name], :success_rate) || 0.0
    end
  end
end
```

**Verification:**
- No syntax errors: `ruby -c app/serializers/plugin_serializer.rb`

### Task 2: Create PluginsController

Create controller with index, enable, and disable actions.

**File:** `app/controllers/plugins_controller.rb`

```ruby
class PluginsController < ApplicationController
  before_action :set_plugin_name, only: [:enable, :disable, :sync]

  def index
    plugins = PluginConfigurationService.all_plugins_summary
    sync_stats = build_sync_stats(plugins)

    render inertia: "Plugins/Index", props: {
      plugins: PluginSerializer::List.new(plugins, params: { sync_stats: sync_stats }).serializable_hash
    }
  end

  def enable
    service = PluginConfigurationService.new(plugin_name: @plugin_name)
    result = service.enable!

    if result[:success]
      redirect_to plugins_path, notice: t("flash.plugins.enabled", name: @plugin_name)
    else
      redirect_to plugins_path, alert: result[:errors].to_sentence
    end
  rescue PluginRegistry::NotFoundError => e
    redirect_to plugins_path, alert: e.message
  end

  def disable
    service = PluginConfigurationService.new(plugin_name: @plugin_name)
    result = service.disable!

    if result[:success]
      redirect_to plugins_path, notice: t("flash.plugins.disabled", name: @plugin_name)
    else
      redirect_to plugins_path, alert: result[:errors].to_sentence
    end
  rescue PluginRegistry::NotFoundError => e
    redirect_to plugins_path, alert: e.message
  end

  def sync
    service = SyncExecutionService.new
    result = service.execute(plugin_name: @plugin_name)

    if result[:success]
      redirect_to plugins_path, notice: t("flash.plugins.sync_complete", name: @plugin_name)
    else
      redirect_to plugins_path, alert: t("flash.plugins.sync_failed", name: @plugin_name, error: result[:error])
    end
  rescue PluginRegistry::NotFoundError => e
    redirect_to plugins_path, alert: e.message
  end

  private

  def set_plugin_name
    @plugin_name = params[:id]
  end

  def build_sync_stats(plugins)
    stats = {}
    plugins.each do |plugin|
      stats[plugin[:plugin_name]] = SyncHistory.stats_for_plugin(plugin[:plugin_name])
    end
    stats
  end
end
```

**Verification:**
- No syntax errors: `ruby -c app/controllers/plugins_controller.rb`

### Task 3: Add routes for plugins

Update routes file to add plugins resource.

**File:** `config/routes.rb` (modify existing)

Add after the existing routes (before the health check route):

```ruby
resources :plugins, only: [:index] do
  member do
    patch :enable
    patch :disable
    post :sync
  end
end
```

**Verification:**
- Run: `bin/rails routes | grep plugin`
- Should show index, enable, disable, and sync routes

### Task 4: Add flash message translations

Add translation keys for plugin flash messages.

**File:** `config/locales/en.yml` (modify existing)

Add under the `flash:` key:

```yaml
plugins:
  enabled: "Plugin '%{name}' has been enabled."
  disabled: "Plugin '%{name}' has been disabled."
  sync_complete: "Plugin '%{name}' sync completed successfully."
  sync_failed: "Plugin '%{name}' sync failed: %{error}"
```

**File:** `config/locales/cs.yml` (modify existing)

Add under the `flash:` key:

```yaml
plugins:
  enabled: "Plugin '%{name}' byl aktivovan."
  disabled: "Plugin '%{name}' byl deaktivovan."
  sync_complete: "Synchronizace pluginu '%{name}' byla uspesna."
  sync_failed: "Synchronizace pluginu '%{name}' selhala: %{error}"
```

**Verification:**
- No YAML syntax errors

### Task 5: Create Plugins/Index.tsx page component

Create the React page component for listing plugins.

**File:** `app/frontend/pages/Plugins/Index.tsx`

```tsx
import { Head, usePage, router } from "@inertiajs/react";
import { useEffect, useState } from "react";
import { useTranslation } from "react-i18next";
import { toast } from "sonner";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Toaster } from "@/components/ui/sonner";

interface Plugin {
  plugin_name: string;
  plugin_version: string;
  plugin_description: string;
  enabled: boolean;
  configured: boolean;
  last_sync_at: string | null;
  last_sync_status: string | null;
  total_syncs: number;
  success_rate: number;
}

interface PageProps {
  plugins: Plugin[];
  flash: {
    alert?: string;
    notice?: string;
  };
  [key: string]: unknown;
}

function getStatusBadgeClass(status: string | null): string {
  switch (status) {
    case "completed":
      return "bg-green-100 text-green-700";
    case "failed":
      return "bg-red-100 text-red-700";
    case "running":
      return "bg-blue-100 text-blue-700";
    default:
      return "bg-stone-100 text-stone-600";
  }
}

function formatDate(dateString: string | null): string {
  if (!dateString) return "-";
  const date = new Date(dateString);
  return date.toLocaleDateString(undefined, {
    month: "short",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}

export default function PluginsIndex() {
  const { plugins, flash } = usePage<PageProps>().props;
  const { t } = useTranslation();
  const [togglingPlugins, setTogglingPlugins] = useState<Set<string>>(new Set());
  const [syncingPlugins, setSyncingPlugins] = useState<Set<string>>(new Set());

  useEffect(() => {
    if (flash.notice) {
      toast.success(flash.notice);
    }
    if (flash.alert) {
      toast.error(flash.alert);
    }
  }, [flash.notice, flash.alert]);

  const handleToggle = (plugin: Plugin) => {
    const action = plugin.enabled ? "disable" : "enable";
    setTogglingPlugins((prev) => new Set(prev).add(plugin.plugin_name));

    router.patch(
      `/plugins/${plugin.plugin_name}/${action}`,
      {},
      {
        preserveScroll: true,
        onFinish: () => {
          setTogglingPlugins((prev) => {
            const next = new Set(prev);
            next.delete(plugin.plugin_name);
            return next;
          });
        },
      }
    );
  };

  const handleSync = (plugin: Plugin) => {
    setSyncingPlugins((prev) => new Set(prev).add(plugin.plugin_name));

    router.post(
      `/plugins/${plugin.plugin_name}/sync`,
      {},
      {
        preserveScroll: true,
        onFinish: () => {
          setSyncingPlugins((prev) => {
            const next = new Set(prev);
            next.delete(plugin.plugin_name);
            return next;
          });
        },
      }
    );
  };

  const handleConfigure = (plugin: Plugin) => {
    router.visit(`/plugins/${plugin.plugin_name}/configure`);
  };

  return (
    <>
      <Head title={t("pages.plugins.title")} />
      <Toaster position="top-right" />

      <div className="p-4 sm:p-6 lg:p-8">
        <div className="mb-6 sm:mb-8">
          <h1 className="text-2xl font-semibold text-stone-900">
            {t("pages.plugins.title")}
          </h1>
          <p className="text-stone-500 mt-1">{t("pages.plugins.subtitle")}</p>
        </div>

        {plugins.length === 0 ? (
          <div className="bg-white rounded-xl border border-stone-200 p-8 text-center">
            <div className="w-12 h-12 mx-auto mb-4 bg-stone-100 rounded-lg flex items-center justify-center">
              <svg
                className="w-6 h-6 text-stone-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth="1.5"
                  d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                />
              </svg>
            </div>
            <h3 className="font-medium text-stone-900 mb-1">
              {t("pages.plugins.noPlugins")}
            </h3>
            <p className="text-sm text-stone-500">
              {t("pages.plugins.noPluginsDescription")}
            </p>
          </div>
        ) : (
          <div className="space-y-4">
            {plugins.map((plugin) => (
              <div
                key={plugin.plugin_name}
                className="bg-white rounded-xl border border-stone-200 p-6"
              >
                <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                      <h3 className="font-semibold text-stone-900">
                        {plugin.plugin_name}
                      </h3>
                      <span className="text-xs text-stone-500 bg-stone-100 px-2 py-0.5 rounded">
                        v{plugin.plugin_version}
                      </span>
                      {plugin.configured ? (
                        <span className="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded">
                          {t("pages.plugins.configured")}
                        </span>
                      ) : (
                        <span className="text-xs text-amber-600 bg-amber-50 px-2 py-0.5 rounded">
                          {t("pages.plugins.notConfigured")}
                        </span>
                      )}
                    </div>
                    <p className="text-sm text-stone-600 mb-3">
                      {plugin.plugin_description}
                    </p>

                    {/* Sync stats */}
                    <div className="flex flex-wrap items-center gap-4 text-sm">
                      <div className="flex items-center gap-2">
                        <span className="text-stone-500">
                          {t("pages.plugins.lastSync")}:
                        </span>
                        {plugin.last_sync_status && (
                          <span
                            className={`px-2 py-0.5 rounded text-xs font-medium ${getStatusBadgeClass(
                              plugin.last_sync_status
                            )}`}
                          >
                            {plugin.last_sync_status}
                          </span>
                        )}
                        <span className="text-stone-700">
                          {formatDate(plugin.last_sync_at)}
                        </span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-stone-500">
                          {t("pages.plugins.totalSyncs")}:
                        </span>
                        <span className="text-stone-700 font-medium">
                          {plugin.total_syncs}
                        </span>
                      </div>
                      {plugin.total_syncs > 0 && (
                        <div className="flex items-center gap-2">
                          <span className="text-stone-500">
                            {t("pages.plugins.successRate")}:
                          </span>
                          <span className="text-stone-700 font-medium">
                            {plugin.success_rate.toFixed(1)}%
                          </span>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="flex items-center gap-4">
                    {/* Configure button */}
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleConfigure(plugin)}
                      className="text-stone-600"
                    >
                      {t("pages.plugins.configure")}
                    </Button>

                    {/* Sync button */}
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleSync(plugin)}
                      disabled={
                        !plugin.enabled ||
                        !plugin.configured ||
                        syncingPlugins.has(plugin.plugin_name)
                      }
                      className="text-stone-600"
                    >
                      {syncingPlugins.has(plugin.plugin_name) ? (
                        <>
                          <svg
                            className="animate-spin -ml-1 mr-2 h-4 w-4"
                            fill="none"
                            viewBox="0 0 24 24"
                          >
                            <circle
                              className="opacity-25"
                              cx="12"
                              cy="12"
                              r="10"
                              stroke="currentColor"
                              strokeWidth="4"
                            />
                            <path
                              className="opacity-75"
                              fill="currentColor"
                              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                            />
                          </svg>
                          {t("pages.plugins.syncing")}
                        </>
                      ) : (
                        t("pages.plugins.syncNow")
                      )}
                    </Button>

                    {/* Enable/Disable toggle */}
                    <div className="flex items-center gap-2">
                      <Switch
                        checked={plugin.enabled}
                        onCheckedChange={() => handleToggle(plugin)}
                        disabled={togglingPlugins.has(plugin.plugin_name)}
                        aria-label={
                          plugin.enabled
                            ? t("pages.plugins.disable")
                            : t("pages.plugins.enable")
                        }
                      />
                      <span className="text-sm text-stone-600 min-w-[60px]">
                        {plugin.enabled
                          ? t("pages.plugins.enabled")
                          : t("pages.plugins.disabled")}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </>
  );
}
```

**Verification:**
- No TypeScript errors: `npm run typecheck`

### Task 6: Add page translations

Add translation keys for the Plugins page.

**File:** `config/locales/en.yml` (modify existing)

Add under the `pages:` key:

```yaml
plugins:
  title: "Plugins"
  subtitle: "Manage integrations and data sync plugins"
  noPlugins: "No plugins available"
  noPluginsDescription: "Plugins will appear here once they are installed."
  configured: "Configured"
  notConfigured: "Not configured"
  lastSync: "Last sync"
  totalSyncs: "Total syncs"
  successRate: "Success rate"
  configure: "Configure"
  syncNow: "Sync now"
  syncing: "Syncing..."
  enable: "Enable plugin"
  disable: "Disable plugin"
  enabled: "Enabled"
  disabled: "Disabled"
```

**File:** `config/locales/cs.yml` (modify existing)

Add under the `pages:` key:

```yaml
plugins:
  title: "Pluginy"
  subtitle: "Sprava integraci a synchronizacnich pluginu"
  noPlugins: "Zadne pluginy"
  noPluginsDescription: "Pluginy se zobrazi az budou nainstalovany."
  configured: "Nakonfigurovano"
  notConfigured: "Nenastaveno"
  lastSync: "Posledni sync"
  totalSyncs: "Celkem syncu"
  successRate: "Uspesnost"
  configure: "Nastavit"
  syncNow: "Synchronizovat"
  syncing: "Synchronizuji..."
  enable: "Aktivovat plugin"
  disable: "Deaktivovat plugin"
  enabled: "Aktivni"
  disabled: "Neaktivni"
```

**Verification:**
- YAML files are valid

### Task 7: Write request specs for PluginsController

**File:** `spec/requests/plugins_controller_spec.rb`

```ruby
require "rails_helper"

RSpec.describe "PluginsController", type: :request do
  before do
    # Authenticate as test user
    user = User.first || create(:user)
    post session_path, params: { email: user.email, password: "password" }
  end

  describe "GET /plugins" do
    it "renders the plugins index page" do
      get plugins_path

      expect(response).to have_http_status(:success)
    end

    it "includes all registered plugins in props" do
      get plugins_path

      # Response includes Inertia page component
      expect(response.body).to include("Plugins/Index")
    end
  end

  describe "PATCH /plugins/:id/enable" do
    let(:plugin_name) { "example" }

    it "enables the plugin" do
      patch enable_plugin_path(plugin_name)

      expect(response).to redirect_to(plugins_path)
      follow_redirect!

      config = PluginConfiguration.find_by(plugin_name: plugin_name)
      expect(config.enabled).to be true
    end

    it "shows success notice" do
      patch enable_plugin_path(plugin_name)

      expect(flash[:notice]).to include("enabled")
    end

    context "with invalid plugin name" do
      it "shows error alert" do
        patch enable_plugin_path("nonexistent")

        expect(response).to redirect_to(plugins_path)
        expect(flash[:alert]).to include("not found")
      end
    end
  end

  describe "PATCH /plugins/:id/disable" do
    let(:plugin_name) { "example" }

    before do
      create(:plugin_configuration, plugin_name: plugin_name, enabled: true)
    end

    it "disables the plugin" do
      patch disable_plugin_path(plugin_name)

      expect(response).to redirect_to(plugins_path)

      config = PluginConfiguration.find_by(plugin_name: plugin_name)
      expect(config.enabled).to be false
    end

    it "shows success notice" do
      patch disable_plugin_path(plugin_name)

      expect(flash[:notice]).to include("disabled")
    end
  end

  describe "POST /plugins/:id/sync" do
    let(:plugin_name) { "example" }

    before do
      create(:plugin_configuration,
             plugin_name: plugin_name,
             enabled: true,
             credentials: { api_key: "test" }.to_json)
    end

    it "executes plugin sync" do
      expect {
        post sync_plugin_path(plugin_name)
      }.to change(SyncHistory, :count).by(1)

      expect(response).to redirect_to(plugins_path)
    end

    context "when plugin is not enabled" do
      before do
        PluginConfiguration.find_by(plugin_name: plugin_name).update!(enabled: false)
      end

      it "shows error alert" do
        post sync_plugin_path(plugin_name)

        expect(response).to redirect_to(plugins_path)
        expect(flash[:alert]).to include("failed")
      end
    end

    context "when plugin is not configured" do
      before do
        PluginConfiguration.find_by(plugin_name: plugin_name).update!(credentials: nil)
      end

      it "shows error alert" do
        post sync_plugin_path(plugin_name)

        expect(response).to redirect_to(plugins_path)
        expect(flash[:alert]).to include("failed")
      end
    end
  end
end
```

**Verification:**
- Run: `bundle exec rspec spec/requests/plugins_controller_spec.rb`
- All examples pass

### Task 8: Write serializer specs

**File:** `spec/serializers/plugin_serializer_spec.rb`

```ruby
require "rails_helper"

RSpec.describe PluginSerializer do
  let(:plugin_summary) do
    {
      plugin_name: "example",
      plugin_version: "1.0.0",
      plugin_description: "Example plugin",
      enabled: true,
      configured: true,
      has_settings: false,
      created_at: Time.current,
      updated_at: Time.current
    }
  end

  describe PluginSerializer::List do
    let(:sync_stats) do
      {
        "example" => {
          total_syncs: 10,
          success_rate: 95.5,
          last_sync: {
            completed_at: "2026-01-12T10:00:00Z",
            status: "completed"
          }
        }
      }
    end

    it "serializes plugin with sync stats" do
      result = described_class.new([plugin_summary], params: { sync_stats: sync_stats }).serializable_hash

      plugin = result.first
      expect(plugin[:plugin_name]).to eq("example")
      expect(plugin[:plugin_version]).to eq("1.0.0")
      expect(plugin[:enabled]).to be true
      expect(plugin[:configured]).to be true
      expect(plugin[:total_syncs]).to eq(10)
      expect(plugin[:success_rate]).to eq(95.5)
      expect(plugin[:last_sync_status]).to eq("completed")
    end

    it "handles missing sync stats" do
      result = described_class.new([plugin_summary], params: { sync_stats: {} }).serializable_hash

      plugin = result.first
      expect(plugin[:total_syncs]).to eq(0)
      expect(plugin[:success_rate]).to eq(0.0)
      expect(plugin[:last_sync_at]).to be_nil
      expect(plugin[:last_sync_status]).to be_nil
    end
  end
end
```

**Verification:**
- Run: `bundle exec rspec spec/serializers/plugin_serializer_spec.rb`
- All examples pass

## Acceptance Criteria

- [ ] `PluginsController` with index, enable, disable, sync actions
- [ ] `PluginSerializer` with List variant for plugin data
- [ ] Routes for GET /plugins, PATCH /plugins/:id/enable, PATCH /plugins/:id/disable, POST /plugins/:id/sync
- [ ] `Plugins/Index.tsx` page component renders plugin list
- [ ] Enable/disable toggle works via Switch component
- [ ] Sync button triggers plugin sync execution
- [ ] Flash messages displayed via toast notifications
- [ ] Translations for EN and CS locales
- [ ] All specs pass: `bundle exec rspec spec/requests/plugins_controller_spec.rb spec/serializers/plugin_serializer_spec.rb`

## Rollback Plan

If issues are found:
1. Remove `app/controllers/plugins_controller.rb`
2. Remove `app/serializers/plugin_serializer.rb`
3. Remove `app/frontend/pages/Plugins/Index.tsx`
4. Revert routes changes in `config/routes.rb`
5. Revert locale changes
6. Remove spec files

## Notes

- The Configure button navigates to `/plugins/:id/configure` which will be implemented in Plan 07-02
- Sync button is disabled when plugin is not enabled or not configured
- Plugin list shows sync statistics from SyncHistory model
- Switch component uses amber color scheme consistent with app design
- The page follows existing patterns from Clients/Index.tsx and Settings/Show.tsx
