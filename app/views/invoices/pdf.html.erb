<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice <%= @invoice.number %></title>
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: 12px;
      line-height: 1.5;
      color: #1c1917;
      background: white;
    }

    /* Page setup for print */
    @page {
      size: A4;
      margin: 20mm;
    }

    @media print {
      body {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }
    }

    /* Layout */
    .invoice-container {
      max-width: 210mm;
      margin: 0 auto;
      padding: 0;
    }

    /* Header section with invoice title */
    .invoice-header {
      text-align: right;
      margin-bottom: 30px;
    }

    .invoice-header-line {
      width: 200px;
      height: 2px;
      background: #1c1917;
      margin-left: auto;
      margin-bottom: 12px;
    }

    .invoice-title {
      font-size: 28px;
      font-weight: 600;
      color: #1c1917;
    }

    .invoice-title .number {
      color: #78716c;
    }

    .invoice-subtitle {
      font-size: 11px;
      color: #78716c;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 4px;
    }

    /* Two-column layout for supplier/customer */
    .parties-section {
      display: flex;
      gap: 40px;
      margin-bottom: 40px;
    }

    .party-column {
      flex: 1;
    }

    .party-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .party-header-line {
      width: 20px;
      height: 2px;
      background: #1c1917;
    }

    .party-label {
      font-size: 11px;
      color: #78716c;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .party-name {
      font-weight: 600;
      font-size: 14px;
      color: #1c1917;
      margin-bottom: 4px;
    }

    .party-address {
      font-size: 11px;
      color: #44403c;
      white-space: pre-line;
      margin-bottom: 16px;
    }

    .party-details-table {
      width: 100%;
      font-size: 11px;
    }

    .party-details-table tr {
      height: 24px;
    }

    .party-details-table td:first-child {
      color: #78716c;
      padding-right: 16px;
    }

    .party-details-table td:last-child {
      text-align: right;
      color: #1c1917;
      font-weight: 500;
    }

    /* Line items table */
    .line-items {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    .line-items thead tr {
      border-bottom: 1px solid #e7e5e4;
    }

    .line-items th {
      text-align: right;
      padding: 12px 8px;
      font-size: 11px;
      font-weight: 500;
      color: #78716c;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .line-items th:first-child,
    .line-items th:nth-child(2),
    .line-items th:nth-child(3) {
      text-align: left;
    }

    .line-items tbody tr {
      border-bottom: 1px solid #f5f5f4;
    }

    .line-items tbody tr:last-child {
      border-bottom: none;
    }

    .line-items td {
      padding: 12px 8px;
      font-size: 11px;
      vertical-align: middle;
    }

    .line-items .qty-col {
      width: 40px;
      text-align: left;
      font-weight: 500;
      color: #1c1917;
    }

    .line-items .unit-col {
      width: 40px;
      text-align: left;
      color: #78716c;
    }

    .line-items .description-col {
      color: #44403c;
    }

    .line-items .vat-col {
      width: 60px;
      text-align: right;
      color: #78716c;
      font-variant-numeric: tabular-nums;
    }

    .line-items .rate-col {
      width: 100px;
      text-align: right;
      color: #78716c;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .line-items .amount-col {
      width: 120px;
      text-align: right;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    /* Totals section */
    .totals-section {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 40px;
    }

    .totals-table {
      width: 280px;
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 12px;
    }

    .totals-row:first-child {
      border-bottom: 1px solid #e7e5e4;
    }

    .totals-row dt {
      color: #78716c;
    }

    .totals-row dd {
      font-variant-numeric: tabular-nums;
      color: #1c1917;
      white-space: nowrap;
      text-align: right;
    }

    .totals-row.total {
      border-top: 2px solid #1c1917;
      border-bottom: none;
      padding-top: 12px;
      margin-top: 4px;
    }

    .totals-row.total dd {
      font-weight: 700;
      font-size: 18px;
      color: #1c1917;
    }

    /* Notes section */
    .notes-section {
      padding-top: 30px;
      border-top: 1px solid #e7e5e4;
      margin-bottom: 30px;
    }

    .notes-title {
      font-size: 11px;
      font-weight: 500;
      color: #44403c;
      margin-bottom: 8px;
    }

    .notes-content {
      font-size: 11px;
      color: #78716c;
      white-space: pre-line;
    }

    /* Footer with QR positioning */
    .footer-wrapper {
      padding-top: 20px;
      border-top: 1px solid #e7e5e4;
    }

    .qr-code-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .qr-code {
      width: 2cm;
      height: 2cm;
    }

    .qr-instruction {
      margin-top: 4px;
      font-size: 9px;
      color: #78716c;
    }

    /* Invoice message */
    .invoice-message {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e7e5e4;
      font-size: 11px;
      color: #78716c;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div class="invoice-container">
    <!-- Invoice Header -->
    <div class="invoice-header">
      <div class="invoice-header-line"></div>
      <div class="invoice-title">
        <%= t('invoices.pdf.invoice') %> <span class="number"><%= @invoice.number %></span>
      </div>
      <div class="invoice-subtitle"><%= t('invoices.pdf.tax_document') %></div>
    </div>

    <!-- Supplier and Customer Section -->
    <div class="parties-section">
      <!-- Supplier Column -->
      <div class="party-column">
        <div class="party-header">
          <div class="party-header-line"></div>
          <span class="party-label"><%= t('invoices.pdf.supplier') %></span>
        </div>
        <div class="party-name"><%= @settings.company_name || t('invoices.pdf.your_company') %></div>
        <div class="party-address"><%= @settings.address %></div>
        <table class="party-details-table">
          <% if @settings.company_registration.present? %>
            <tr>
              <td><%= t('invoices.pdf.reg_no') %></td>
              <td><%= @settings.company_registration %></td>
            </tr>
          <% end %>
          <% if @settings.vat_id.present? %>
            <tr>
              <td><%= t('invoices.pdf.vat_id') %></td>
              <td><%= @settings.vat_id %></td>
            </tr>
          <% end %>
          <% if @settings.bank_account.present? %>
            <tr>
              <td><%= t('invoices.pdf.bank_account') %></td>
              <td><%= @settings.bank_account %></td>
            </tr>
          <% end %>
          <% if @settings.iban.present? %>
            <tr>
              <td><%= t('invoices.pdf.iban') %></td>
              <td><%= @settings.iban %></td>
            </tr>
          <% end %>
          <% if @settings.bank_swift.present? %>
            <tr>
              <td><%= t('invoices.pdf.swift_bic') %></td>
              <td><%= @settings.bank_swift %></td>
            </tr>
          <% end %>
          <tr>
            <td><%= t('invoices.pdf.reference') %></td>
            <td><%= @invoice.number %></td>
          </tr>
          <tr>
            <td><%= t('invoices.pdf.payment_method') %></td>
            <td><%= t('invoices.pdf.bank_transfer') %></td>
          </tr>
        </table>
      </div>

      <!-- Customer Column -->
      <div class="party-column">
        <div class="party-header">
          <div class="party-header-line"></div>
          <span class="party-label"><%= t('invoices.pdf.customer') %></span>
        </div>
        <div class="party-name"><%= @invoice.client.name %></div>
        <div class="party-address"><%= @invoice.client.address %></div>
        <table class="party-details-table">
          <% if @invoice.client.company_registration.present? %>
            <tr>
              <td><%= t('invoices.pdf.reg_no') %></td>
              <td><%= @invoice.client.company_registration %></td>
            </tr>
          <% end %>
          <% if @invoice.client.vat_id.present? %>
            <tr>
              <td><%= t('invoices.pdf.vat_id') %></td>
              <td><%= @invoice.client.vat_id %></td>
            </tr>
          <% end %>
          <tr>
            <td><%= t('invoices.pdf.issued_on') %></td>
            <td><%= @invoice.issue_date ? l(@invoice.issue_date, format: :invoice) : t('invoices.pdf.not_set') %></td>
          </tr>
          <tr>
            <td><%= t('invoices.pdf.due_on') %></td>
            <td><%= @invoice.due_date ? l(@invoice.due_date, format: :invoice) : t('invoices.pdf.not_set') %></td>
          </tr>
          <tr>
            <td><%= t('invoices.pdf.date_of_supply') %></td>
            <td><%= @invoice.issue_date ? l(@invoice.issue_date, format: :invoice) : t('invoices.pdf.not_set') %></td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Line Items Table -->
    <table class="line-items">
      <thead>
        <tr>
          <th></th>
          <th></th>
          <th></th>
          <th><%= t('invoices.pdf.vat') %></th>
          <th><%= t('invoices.pdf.unit_price') %></th>
          <th><%= t('invoices.pdf.total_wo_vat') %></th>
        </tr>
      </thead>
      <tbody>
        <% @invoice.line_items.each do |item| %>
          <tr>
            <td class="qty-col">
              <% if item.time_aggregate? && item.quantity.present? %>
                <%= item.quantity.to_i %>
              <% end %>
            </td>
            <td class="unit-col">
              <% if item.time_aggregate? && item.quantity.present? %>
                <%= t('invoices.pdf.hours_unit') %>
              <% end %>
            </td>
            <td class="description-col"><%= item.description %></td>
            <td class="vat-col"><%= number_with_precision(item.vat_rate, precision: 0) %> %</td>
            <td class="rate-col">
              <% if item.time_aggregate? && item.unit_price.present? %>
                <%= format_rate(item.unit_price, @invoice.currency) %>
              <% end %>
            </td>
            <td class="amount-col"><%= format_currency(item.amount, @invoice.currency) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <!-- Totals Section -->
    <div class="totals-section">
      <dl class="totals-table">
        <div class="totals-row">
          <dt><%= t('invoices.pdf.total_wo_vat') %></dt>
          <dd><%= format_currency(@invoice.subtotal, @invoice.currency) %></dd>
        </div>
        <% vat_totals = @invoice.vat_totals_by_rate %>
        <% if vat_totals.values.any? { |v| v > 0 } %>
          <% vat_totals.select { |rate, amount| rate.to_f > 0 }.sort_by { |rate, _| -rate.to_f }.each do |rate, amount| %>
            <div class="totals-row">
              <dt><%= t('invoices.pdf.vat') %> <%= number_with_precision(rate, precision: 0) %> %</dt>
              <dd><%= format_currency(amount, @invoice.currency) %></dd>
            </div>
          <% end %>
        <% else %>
          <div class="totals-row">
            <dt><%= t('invoices.pdf.vat') %> 0 %</dt>
            <dd><%= format_currency(0, @invoice.currency) %></dd>
          </div>
        <% end %>
        <div class="totals-row total">
          <dt></dt>
          <dd><%= format_currency(@invoice.grand_total, @invoice.currency) %></dd>
        </div>
      </dl>
    </div>

    <!-- Notes Section (if present) -->
    <% if @invoice.notes.present? %>
      <div class="notes-section">
        <div class="notes-title"><%= t('invoices.pdf.notes') %></div>
        <div class="notes-content"><%= @invoice.notes %></div>
      </div>
    <% end %>

    <!-- Footer - QR Code -->
    <% if @qr_code_data_url %>
      <div class="footer-wrapper">
        <div class="qr-code-container">
          <img src="<%= @qr_code_data_url %>" alt="<%= t('invoices.pdf.qr_alt') %>" class="qr-code" />
          <p class="qr-instruction"><%= t('invoices.pdf.scan_to_pay') %></p>
        </div>
      </div>
    <% end %>

    <!-- Invoice Message -->
    <% if @settings.invoice_message.present? %>
      <div class="invoice-message">
        <%= @settings.invoice_message %>
      </div>
    <% end %>
  </div>
</body>
</html>
