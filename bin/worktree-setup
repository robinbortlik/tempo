#!/usr/bin/env bash
set -e

# Setup a new git worktree for parallel feature development
# Usage: bin/worktree-setup <feature-name> [branch-name] [port-offset]
#
# Examples:
#   bin/worktree-setup auth                    # Creates ../invoicing-auth from new branch feature/auth
#   bin/worktree-setup payments main           # Creates ../invoicing-payments from main branch
#   bin/worktree-setup api feature/api-v2 3    # Creates with specific branch and port offset

FEATURE_NAME="${1:-}"
BRANCH_NAME="${2:-}"
PORT_OFFSET="${3:-}"

if [ -z "$FEATURE_NAME" ]; then
  echo "Usage: bin/worktree-setup <feature-name> [branch-name] [port-offset]"
  echo ""
  echo "Creates a new git worktree with isolated environment for parallel development."
  echo ""
  echo "Arguments:"
  echo "  feature-name  - Short name for the feature (e.g., 'auth', 'payments')"
  echo "  branch-name   - Git branch to use (default: creates feature/<feature-name>)"
  echo "  port-offset   - Port offset for Rails/Vite (default: auto-assigned)"
  echo ""
  echo "Examples:"
  echo "  bin/worktree-setup auth"
  echo "  bin/worktree-setup payments main"
  echo "  bin/worktree-setup api feature/api-v2 3"
  echo ""
  echo "The new worktree will be created at: ../invoicing-<feature-name>"
  exit 1
fi

# Get the parent directory and project name
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
PARENT_DIR="$(dirname "$PROJECT_DIR")"
WORKTREE_PATH="$PARENT_DIR/invoicing-$FEATURE_NAME"

# Determine branch name
if [ -z "$BRANCH_NAME" ]; then
  BRANCH_NAME="feature/$FEATURE_NAME"
fi

# Auto-assign port offset if not provided
if [ -z "$PORT_OFFSET" ]; then
  # Count existing worktrees to determine offset
  WORKTREE_COUNT=$(git worktree list | wc -l | tr -d ' ')
  PORT_OFFSET=$WORKTREE_COUNT
fi

RAILS_PORT=$((3000 + PORT_OFFSET))
VITE_PORT=$((3136 + PORT_OFFSET))

echo "Creating worktree for feature: $FEATURE_NAME"
echo "  Path:     $WORKTREE_PATH"
echo "  Branch:   $BRANCH_NAME"
echo "  Rails:    http://localhost:$RAILS_PORT"
echo "  Vite:     http://localhost:$VITE_PORT"
echo ""

# Check if worktree already exists
if [ -d "$WORKTREE_PATH" ]; then
  echo "Error: Worktree already exists at $WORKTREE_PATH"
  echo "To remove it: git worktree remove $WORKTREE_PATH"
  exit 1
fi

# Check if branch exists, create if not
if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
  echo "Using existing branch: $BRANCH_NAME"
  git worktree add "$WORKTREE_PATH" "$BRANCH_NAME"
else
  echo "Creating new branch: $BRANCH_NAME"
  git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH"
fi

# Change to new worktree
cd "$WORKTREE_PATH"

# Create .env.local with environment-specific config
cat > .env.local << EOF
# Parallel development environment for: $FEATURE_NAME
# Auto-generated by bin/worktree-setup

# Server ports
PORT=$RAILS_PORT
VITE_RUBY_PORT=$VITE_PORT

# Database isolation
DATABASE_NAME=$FEATURE_NAME
EOF

echo ""
echo "Installing dependencies..."

# Install Ruby dependencies
bundle install

# Install Node dependencies
npm install

# Setup database
echo ""
echo "Setting up database..."
bin/rails db:prepare

echo ""
echo "=========================================="
echo "Worktree setup complete!"
echo "=========================================="
echo ""
echo "To start developing:"
echo "  cd $WORKTREE_PATH"
echo "  bin/dev"
echo ""
echo "The .env.local file has been created with:"
echo "  - Rails port: $RAILS_PORT"
echo "  - Vite port: $VITE_PORT"
echo "  - Database: storage/development-$FEATURE_NAME.sqlite3"
echo ""
echo "To remove this worktree later:"
echo "  git worktree remove $WORKTREE_PATH"
